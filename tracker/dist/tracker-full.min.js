/* Influencer Tracker v2.1.0 with AI | Built: 2025-09-02T17:42:03.239Z */
!function(t,e,n){"use strict";void 0!==t&&(t.InfluencerTrackerBuild={name:"full",version:"2.1.0",timestamp:"2025-09-02T17:42:03.251Z",files:["src/core/tracker-core.js","src/adapters/shopify-adapter.js","src/ai/ai-data-collector.js","src/utils/helpers.js"],features:{tracking:!0,attribution:!0,adapters:!0,ai:!0}}),function(t,e){const n={apiEndpoint:"",projectId:"",enableConsentCheck:!0,batchSize:10,batchTimeout:3e3,sessionTimeout:18e5,version:"2.0.0"},r={checkConsent:function(){return!n.enableConsentCheck||"granted"===localStorage.getItem("analytics_consent")},waitForConsent:function(t){const e=setInterval(()=>{this.checkConsent()&&(clearInterval(e),t())},500);setTimeout(()=>{clearInterval(e)},1e4)}},i={generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},getUserId:function(){let t=localStorage.getItem("inf_user_id");return t||(t=this.generateUUID(),localStorage.setItem("inf_user_id",t)),t},getSessionId:function(){let t=sessionStorage.getItem("inf_session");if(t){const e=JSON.parse(t),r=Date.now();if(r-e.lastActivity<n.sessionTimeout)return e.lastActivity=r,sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}const e={id:this.generateUUID(),startTime:Date.now(),lastActivity:Date.now()};return sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}},o={detectInfluencer:function(){const n=new URLSearchParams(t.location.search),r=new URLSearchParams(t.location.hash.substring(1)),i={influencer_id:n.get("inf_id")||n.get("influencer")||r.get("inf_id"),campaign_id:n.get("camp_id")||n.get("campaign")||r.get("camp_id"),promo_code:n.get("promo")||n.get("codigo")||r.get("promo"),utm_source:n.get("utm_source"),utm_medium:n.get("utm_medium"),utm_campaign:n.get("utm_campaign"),ref:n.get("ref")},o=e.referrer;let a=null;if(o.includes("instagram.com")?a="instagram":o.includes("tiktok.com")?a="tiktok":o.includes("youtube.com")||o.includes("youtu.be")?a="youtube":o.includes("facebook.com")?a="facebook":(o.includes("twitter.com")||o.includes("x.com"))&&(a="twitter"),Object.values(i).some(t=>null!==t)||a){const e={...i,social_source:a,detected_at:Date.now(),landing_page:t.location.href};return sessionStorage.setItem("inf_attribution",JSON.stringify(e)),e}const c=sessionStorage.getItem("inf_attribution");return c?JSON.parse(c):null}},a={generate:function(){const e=t.screen,n=navigator;return{user_agent:n.userAgent,language:n.language,platform:n.platform,screen_resolution:`${e.width}x${e.height}`,color_depth:e.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,device_memory:n.deviceMemory||null,hardware_concurrency:n.hardwareConcurrency||null,connection:n.connection?{effective_type:n.connection.effectiveType,downlink:n.connection.downlink}:null}}},c={queue:[],add:function(t){this.queue.push(t),this.queue.length>=n.batchSize&&this.flush()},flush:function(){if(0===this.queue.length||!n.apiEndpoint)return;const t=this.queue.splice(0,n.batchSize);fetch(n.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:n.projectId,events:t,version:n.version})}).catch(e=>{console.warn("Influencer Tracker: Failed to send events",e);const n=JSON.parse(localStorage.getItem("inf_failed_events")||"[]");n.push(...t),localStorage.setItem("inf_failed_events",JSON.stringify(n.slice(-100)))})},scheduleFlush:function(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>this.flush(),n.batchTimeout)}},InfluencerTracker={initialized:!1,startTime:Date.now(),platform:"generic",adapter:null,init:function(t={}){this.initialized||(Object.assign(n,t),n.apiEndpoint?(this.platform=this.detectPlatform(),console.log(`🎯 Plataforma detectada: ${this.platform}`),this.adapter=this.loadAdapter(this.platform),!n.enableConsentCheck||r.checkConsent()?this.startTracking():r.waitForConsent(()=>this.startTracking())):console.warn("Influencer Tracker: apiEndpoint não configurado"))},detectPlatform:function(){return t.Shopify||t.shopifyData||e.querySelector('meta[name="shopify-checkout-api-token"]')?"shopify":"generic"},loadAdapter:function(e){return t[`${e}Adapter`]||null},startTracking:function(){this.initialized=!0;const n=o.detectInfluencer();this.track("page_view",{page_url:t.location.href,page_title:e.title,referrer:e.referrer,influencer_data:n}),this.setupUniversalTracking(),this.adapter?.init&&this.adapter.init(),c.scheduleFlush(),t.addEventListener("beforeunload",()=>c.flush()),console.log("Influencer Tracker: Inicializado com sucesso")},track:function(e,n={}){if(!this.initialized)return;const r={event_id:i.generateUUID(),event_type:e,timestamp:Date.now(),user_id:i.getUserId(),session_id:i.getSessionId(),page_url:t.location.href,device_fingerprint:a.generate(),platform:this.platform,properties:n};this.adapter?.enrichEvent&&Object.assign(r.properties,this.adapter.enrichEvent(e,n)),c.add(r)},setupUniversalTracking:function(){let n=0;t.addEventListener("scroll",this.throttle(()=>{const r=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);r>n&&(n=r,[25,50,75,90].includes(r)&&this.track("scroll_milestone",{scroll_percent:r}))},1e3));let r=0;setInterval(()=>{r+=10,[30,60,120,300].includes(r)&&this.track("time_milestone",{seconds_on_page:r})},1e4),this.setupExitTracking()},setupExitTracking:function(){let n=!1;e.addEventListener("mouseleave",r=>{r.clientY<=0&&!n&&(n=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100)}))})},trackPurchase:function(t){this.track("purchase",{order_id:t.orderId,total_value:t.totalValue,currency:t.currency||"BRL",items:t.items,coupon_code:t.couponCode,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null")})},trackCustomEvent:function(t,e){this.track(t,e)},throttle:function(t,e){let n;return function(){const r=arguments;n||(t.apply(this,r),n=!0,setTimeout(()=>n=!1,e))}}};t.InfluencerTracker=InfluencerTracker,t.InfluencerTracker.ConsentManager=r,t.InfluencerTracker.IdGenerator=i,t.InfluencerTracker.InfluencerDetector=o,t.InfluencerTracker.DeviceFingerprint=a,t.InfluencerTracker.EventQueue=c}(t,e),function(t,e){t.shopifyAdapter={lastCartState:null,cartUpdateTimeout:null,init:function(){console.log("🛍️ Inicializando adaptador Shopify"),this.setupShopifyTracking(),this.setupCartTracking(),this.setupProductTracking(),this.setupCheckoutTracking(),this.lastCartState={items:this.getCartItemCount(),value:this.getCartValue()},console.log("🛒 Estado inicial do carrinho:",this.lastCartState)},enrichEvent:function(e,n){const r={shop_domain:t.Shopify?.shop||t.shopifyData?.shop?.domain,currency:t.shopifyData?.shop?.currency||"USD",customer_id:t.shopifyData?.customer?.id,cart_token:this.getCartToken()};return"cart_update"===e&&(r.cart_items=this.getCartItemCount(),r.cart_value=this.getCartValue()),"product_view"===e&&t.shopifyData?.product&&(r.product_id=t.shopifyData.product.id,r.product_handle=t.shopifyData.product.handle,r.product_type=t.shopifyData.product.type,r.product_vendor=t.shopifyData.product.vendor,r.product_price=t.shopifyData.product.price,r.product_available=t.shopifyData.product.available),r},getCartValue:function(){if(console.log("🛒 getCartValue (Shopify)"),t.shopifyData?.cart?.total_price!==n){const e=t.shopifyData.cart.total_price;return console.log("   ✅ Via Shopify data:",e),e}try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status){const e=JSON.parse(t.responseText).total_price/100;return console.log("   ✅ Via API /cart.js:",e),e}}catch(t){console.log("   ❌ Erro API:",t)}const r=["[data-cart-total]",".cart-total","#cart-total",".basket-total",".cart__total",".drawer-cart__total"];for(const t of r){const n=e.querySelector(t);if(n){const t=n.textContent||n.value||n.getAttribute("data-cart-total");if(t){const e=this.parseCartValue(t);if(null!==e)return console.log("   ✅ Via DOM:",e),e}}}return console.log("   ⚠️ Fallback para 0"),0},getCartItemCount:function(){if(t.shopifyData?.cart?.item_count!==n)return t.shopifyData.cart.item_count;try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).item_count}catch(t){console.log("Erro ao buscar item count:",t)}return e.querySelectorAll("[data-cart-item], .cart-item, .line-item").length},getCartToken:function(){try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).token}catch(t){return null}},parseCartValue:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const n=parseFloat(e);return n>1e4?n/100:isNaN(n)?null:n},setupShopifyTracking:function(){const e=t.InfluencerTracker;"product"===t.shopifyData?.page?.type&&e.trackCustomEvent("product_view",{product_id:t.shopifyData.product?.id,product_handle:t.shopifyData.product?.handle,product_title:t.shopifyData.product?.title,product_price:t.shopifyData.product?.price,product_type:t.shopifyData.product?.type,product_vendor:t.shopifyData.product?.vendor,product_available:t.shopifyData.product?.available,variants_count:t.shopifyData.product?.variants?.length}),"collection"===t.shopifyData?.page?.type&&e.trackCustomEvent("collection_view",{collection_id:t.shopifyData.collection?.id,collection_handle:t.shopifyData.collection?.handle,collection_title:t.shopifyData.collection?.title,products_count:t.shopifyData.collection?.products_count}),"cart"===t.shopifyData?.page?.type&&e.trackCustomEvent("cart_view",{cart_items:t.shopifyData.cart?.item_count||0,cart_total:t.shopifyData.cart?.total_price||0,cart_items_detail:t.shopifyData.cart?.items||[]})},setupCartTracking:function(){t.InfluencerTracker,console.log("🛒 Setup cart tracking - Fase 1"),this.interceptShopifyAjax(),["cart:updated","cart:changed","cart:added","cart:removed"].forEach(t=>{e.addEventListener(t,e=>{console.log(`🛒 Evento ${t} detectado`),setTimeout(()=>this.checkCartChange(`shopify_${t}`),300)})}),setInterval(()=>{this.checkCartChange("periodic_check")},3e4),this.lastCartState={items:this.getCartItemCount(),value:this.getCartValue()},console.log("🛒 Estado inicial:",this.lastCartState),console.log("✅ Cart tracking Fase 1 ativo")},interceptShopifyAjax:function(){const e=this,n=t.fetch;t.fetch=async function(...t){const[r,i]=t,o=await n.apply(this,t);return"string"==typeof r&&r.includes("/cart")&&(console.log("🛒 Fetch detectado:",r),setTimeout(()=>e.checkCartChange("ajax_fetch"),500)),o};const r=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,n,...i){return n.includes("/cart")&&(console.log("🛒 XHR detectado:",n),this.addEventListener("load",function(){this.status>=200&&this.status<300&&setTimeout(()=>e.checkCartChange("ajax_xhr"),500)})),r.apply(this,[t,n,...i])},console.log("✅ AJAX interception ativo")},setupProductTracking:function(){const n=t.InfluencerTracker,r=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const e=t.target;n.trackCustomEvent("product_impression",{product_id:e.getAttribute("data-product-id"),product_handle:e.getAttribute("data-product-handle"),product_title:e.getAttribute("data-product-title"),product_price:e.getAttribute("data-product-price"),visibility_percent:Math.round(100*t.intersectionRatio),element_position:this.getElementPosition(e)})}})},{threshold:.5});["[data-product-id]",".product-item",".product-card",".grid-product",".product-grid-item"].forEach(t=>{e.querySelectorAll(t).forEach(t=>{r.observe(t)})}),e.addEventListener("change",e=>{if(e.target.matches('select[name="id"], input[name="id"], .product-form__variants select')){const r=e.target.value;n.trackCustomEvent("variant_selection",{product_id:t.shopifyData?.product?.id,variant_id:r,selection_method:e.target.tagName.toLowerCase()})}})},setupCheckoutTracking:function(){const e=t.InfluencerTracker;t.location.pathname.includes("/checkout")&&(e.trackCustomEvent("checkout_page_view",{checkout_step:this.getCheckoutStep(),cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.setupCheckoutStepTracking()),(t.location.pathname.includes("/thank_you")||t.location.pathname.includes("/orders/"))&&this.trackPurchaseCompletion()},setupCheckoutStepTracking:function(){const n=t.InfluencerTracker,r=new MutationObserver(()=>{const t=this.getCheckoutStep();this.lastCheckoutStep!==t&&(n.trackCustomEvent("shopify_checkout_step_change",{previous_step:this.lastCheckoutStep,current_step:t,cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.lastCheckoutStep=t)}),i=e.querySelector(".checkout, #checkout, .main-content")||e.body;r.observe(i,{childList:!0,subtree:!0})},checkCartChange:function(e){this.cartUpdateTimeout&&clearTimeout(this.cartUpdateTimeout),this.cartUpdateTimeout=setTimeout(()=>{const n={items:this.getCartItemCount(),value:this.getCartValue()};(!this.lastCartState||n.items!==this.lastCartState.items||Math.abs(n.value-this.lastCartState.value)>.01)&&(console.log("🛒 Cart mudou:",this.lastCartState,"→",n),t.InfluencerTracker.track("cart_update",{cart_items:n.items,cart_value:n.value,previous_items:this.lastCartState?.items||0,previous_value:this.lastCartState?.value||0,change_trigger:e,change_type:n.items>(this.lastCartState?.items||0)?"add":n.items<(this.lastCartState?.items||0)?"remove":"update"}),this.lastCartState=n)},1e3)},getCheckoutStep:function(){return e.querySelector('.step-contact, [data-step="contact"]')?"contact":e.querySelector('.step-shipping, [data-step="shipping"]')?"shipping":e.querySelector('.step-payment, [data-step="payment"]')?"payment":e.querySelector('.step-review, [data-step="review"]')?"review":"unknown"},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:e.left,y:e.top,width:e.width,height:e.height}},trackPurchaseCompletion:function(){const e=t.InfluencerTracker,n=this.extractOrderData();e.trackCustomEvent("purchase_completed",{...n,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null"),page_url:t.location.href}),n.order_id&&e.trackPurchase({orderId:n.order_id,totalValue:n.total_value,currency:n.currency,items:n.items,couponCode:n.coupon_code})},extractOrderData:function(){if(t.Shopify?.checkout)return{order_id:t.Shopify.checkout.order_id,total_value:t.Shopify.checkout.total_price/100,currency:t.Shopify.checkout.currency,items:t.Shopify.checkout.line_items,coupon_code:t.Shopify.checkout.discount?.code};const n=e.querySelector(".order-number, [data-order-number]")?.textContent,r=e.querySelector(".total-price, [data-total-price]");return{order_id:n,total_value:r?this.parseCartValue(r.textContent):0,currency:"USD",items:[],coupon_code:null}}}}(t,e),function(t,e){const n={sessionStart:Date.now(),behaviorMetrics:{pageViews:0,productViews:0,cartActions:0,totalClicks:0,scrollDepth:[],timeOnPages:[]},analyzeBehavior:function(){const t=Date.now()-this.sessionStart,e=this.behaviorMetrics;return{behavioral_segment:this.getBehavioralSegment(e,t),conversion_probability:this.getConversionProbability(e,t),engagement_quality:this.getEngagementQuality(e,t),device_tier:this.getDeviceTier(),attribution_confidence:this.getAttributionConfidence()}},getBehavioralSegment:function(t,e){return t.cartActions>0&&e<3e5?"decisive_buyer":t.cartActions>2?"hesitant_buyer":t.productViews>5&&0===t.cartActions?"researcher":t.totalClicks>10?"price_conscious":"casual_browser"},getConversionProbability:function(t,e){let n=0;return t.cartActions>0&&(n+=40),t.productViews>3&&(n+=20),e>18e4&&(n+=20),t.totalClicks>5&&(n+=10),t.pageViews>5&&(n+=10),n>=70?"high":n>=40?"medium":"low"},getEngagementQuality:function(t,e){const n=t.scrollDepth.length>0?t.scrollDepth.reduce((t,e)=>t+e,0)/t.scrollDepth.length:0;let r=0;return r+=5*t.pageViews,r+=e/1e3*.1,r+=2*t.totalClicks,r+=.5*n,r>=100?"high":r>=50?"medium":"low"},getDeviceTier:function(){const e=navigator.deviceMemory||4,n=navigator.hardwareConcurrency||4,r=t.screen,i=r.width*r.height;return e>=8&&n>=8&&i>2073600?"premium":e>=4&&i>921600?"mid_range":"budget"},getAttributionConfidence:function(){let n=.3;const r=new URLSearchParams(t.location.search);return(r.get("affiliate")||r.get("ref"))&&(n+=.4),r.get("utm_source")&&(n+=.2),e.referrer&&["instagram.com","tiktok.com","youtube.com","facebook.com"].some(t=>e.referrer.includes(t))&&(n+=.1),Math.min(n,1)},updateMetrics:function(t,e){switch(t){case"page_view":this.behaviorMetrics.pageViews++;break;case"product_view":case"product_impression":this.behaviorMetrics.productViews++;break;case"cart_update":this.behaviorMetrics.cartActions++;break;case"scroll_milestone":e&&e.scroll_percent&&this.behaviorMetrics.scrollDepth.push(e.scroll_percent);break;case"variant_selection":case"product_impression":this.behaviorMetrics.totalClicks++}},sendAnalysis:function(){const e=this.analyzeBehavior();t.InfluencerTracker&&t.InfluencerTracker.track("ai_session_analysis",{session_analysis:e,session_duration:Date.now()-this.sessionStart,total_events:Object.values(this.behaviorMetrics).reduce((t,e)=>Array.isArray(e)?t+e.length:t+e,0)})}};if(t.InfluencerTracker){const e=t.InfluencerTracker.track;t.InfluencerTracker.track=function(t,r={}){n.updateMetrics(t,r),e.call(this,t,r)},t.InfluencerTracker.getAIAnalysis=function(){return n.analyzeBehavior()}}setInterval(()=>{n.sendAnalysis()},3e5),t.addEventListener("beforeunload",()=>{n.sendAnalysis()}),t.AISessionAnalyzer=n,console.log("🤖 AI Session Analyzer integrated with existing customer_sessions")}(t,e),function(t){t.InfluencerTrackerUtils={debounce:function(t,e,n){let r;return function(){const i=this,o=arguments,a=n&&!r;clearTimeout(r),r=setTimeout(function(){r=null,n||t.apply(i,o)},e),a&&t.apply(i,o)}},throttle:function(t,e){let n;return function(){const r=arguments;n||(t.apply(this,r),n=!0,setTimeout(()=>n=!1,e))}},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:Math.round(e.left),y:Math.round(e.top),width:Math.round(e.width),height:Math.round(e.height)}},parseCurrency:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const n=parseFloat(e);return n>1e4?n/100:isNaN(n)?null:n},isElementVisible:function(n){const r=n.getBoundingClientRect();return r.top>=0&&r.left>=0&&r.bottom<=(t.innerHeight||e.documentElement.clientHeight)&&r.right<=(t.innerWidth||e.documentElement.clientWidth)},getScrollPercentage:function(){const n=t.pageYOffset||e.documentElement.scrollTop,r=e.documentElement.scrollHeight-t.innerHeight;return Math.round(n/r*100)},setCookie:function(t,n,r){const i=r?`; expires=${new Date(Date.now()+864e5*r).toUTCString()}`:"";e.cookie=`${t}=${n}${i}; path=/`},getCookie:function(t){return e.cookie.split("; ").reduce((e,n)=>{const r=n.split("=");return r[0]===t?decodeURIComponent(r[1]):e},"")},setStorage:function(t,e,n=!1){try{return(n?sessionStorage:localStorage).setItem(t,JSON.stringify(e)),!0}catch(r){return console.warn("Storage not available, using cookie fallback"),this.setCookie(t,JSON.stringify(e),n?null:30),!1}},getStorage:function(t,e=!1){try{const n=(e?sessionStorage:localStorage).getItem(t);return n?JSON.parse(n):null}catch(e){const n=this.getCookie(t);return n?JSON.parse(n):null}}}}(t)}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:{});