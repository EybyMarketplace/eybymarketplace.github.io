/* Influencer Tracker v2.1.0 with AI | Built: 2025-09-02T18:51:20.377Z */
!function(t,e){"use strict";void 0!==t&&(t.InfluencerTrackerBuild={name:"full",version:"2.1.0",timestamp:"2025-09-02T18:51:20.385Z",files:["src/core/tracker-core.js","src/adapters/shopify-adapter.js","src/ai/ai-data-collector.js","src/utils/helpers.js"],features:{tracking:!0,attribution:!0,adapters:!0,ai:!0}}),function(t,e){const n={apiEndpoint:"",projectId:"",enableConsentCheck:!0,batchSize:10,batchTimeout:3e3,sessionTimeout:18e5,version:"2.0.0"},i={checkConsent:function(){return!n.enableConsentCheck||"granted"===localStorage.getItem("analytics_consent")},waitForConsent:function(t){const e=setInterval(()=>{this.checkConsent()&&(clearInterval(e),t())},500);setTimeout(()=>{clearInterval(e)},1e4)}},o={generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},getUserId:function(){let t=localStorage.getItem("inf_user_id");return t||(t=this.generateUUID(),localStorage.setItem("inf_user_id",t)),t},getSessionId:function(){let t=sessionStorage.getItem("inf_session");if(t){const e=JSON.parse(t),i=Date.now();if(i-e.lastActivity<n.sessionTimeout)return e.lastActivity=i,sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}const e={id:this.generateUUID(),startTime:Date.now(),lastActivity:Date.now()};return sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}},c={detectInfluencer:function(){const n=new URLSearchParams(t.location.search),i=new URLSearchParams(t.location.hash.substring(1)),o={influencer_id:n.get("inf_id")||n.get("influencer")||i.get("inf_id"),campaign_id:n.get("camp_id")||n.get("campaign")||i.get("camp_id"),promo_code:n.get("promo")||n.get("codigo")||i.get("promo"),utm_source:n.get("utm_source"),utm_medium:n.get("utm_medium"),utm_campaign:n.get("utm_campaign"),ref:n.get("ref")},c=e.referrer;let a=null;if(c.includes("instagram.com")?a="instagram":c.includes("tiktok.com")?a="tiktok":c.includes("youtube.com")||c.includes("youtu.be")?a="youtube":c.includes("facebook.com")?a="facebook":(c.includes("twitter.com")||c.includes("x.com"))&&(a="twitter"),Object.values(o).some(t=>null!==t)||a){const e={...o,social_source:a,detected_at:Date.now(),landing_page:t.location.href};return sessionStorage.setItem("inf_attribution",JSON.stringify(e)),e}const r=sessionStorage.getItem("inf_attribution");return r?JSON.parse(r):null}},a={generate:function(){const e=t.screen,n=navigator;return{user_agent:n.userAgent,language:n.language,platform:n.platform,screen_resolution:`${e.width}x${e.height}`,color_depth:e.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,device_memory:n.deviceMemory||null,hardware_concurrency:n.hardwareConcurrency||null,connection:n.connection?{effective_type:n.connection.effectiveType,downlink:n.connection.downlink}:null}}},r={queue:[],add:function(t){this.queue.push(t),this.queue.length>=n.batchSize&&this.flush()},flush:function(){if(0===this.queue.length||!n.apiEndpoint)return;const t=this.queue.splice(0,n.batchSize);fetch(n.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:n.projectId,events:t,version:n.version})}).catch(e=>{console.warn("Influencer Tracker: Failed to send events",e);const n=JSON.parse(localStorage.getItem("inf_failed_events")||"[]");n.push(...t),localStorage.setItem("inf_failed_events",JSON.stringify(n.slice(-100)))})},scheduleFlush:function(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>this.flush(),n.batchTimeout)}},InfluencerTracker={initialized:!1,startTime:Date.now(),platform:"generic",adapter:null,init:function(t={}){this.initialized||(Object.assign(n,t),n.apiEndpoint?(this.platform=this.detectPlatform(),console.log(`üéØ Plataforma detectada: ${this.platform}`),this.adapter=this.loadAdapter(this.platform),!n.enableConsentCheck||i.checkConsent()?this.startTracking():i.waitForConsent(()=>this.startTracking())):console.warn("Influencer Tracker: apiEndpoint n√£o configurado"))},detectPlatform:function(){return t.Shopify||t.shopifyData||e.querySelector('meta[name="shopify-checkout-api-token"]')?"shopify":"generic"},loadAdapter:function(e){return t[`${e}Adapter`]||null},startTracking:function(){this.initialized=!0;const n=c.detectInfluencer();this.track("page_view",{page_url:t.location.href,page_title:e.title,referrer:e.referrer,influencer_data:n}),this.setupUniversalTracking(),this.adapter?.init&&this.adapter.init(),r.scheduleFlush(),t.addEventListener("beforeunload",()=>r.flush()),console.log("Influencer Tracker: Inicializado com sucesso")},track:function(e,n={}){if(!this.initialized)return;const i={event_id:o.generateUUID(),event_type:e,timestamp:Date.now(),user_id:o.getUserId(),session_id:o.getSessionId(),page_url:t.location.href,device_fingerprint:a.generate(),platform:this.platform,properties:n};this.adapter?.enrichEvent&&Object.assign(i.properties,this.adapter.enrichEvent(e,n)),r.add(i)},setupUniversalTracking:function(){let n=0;t.addEventListener("scroll",this.throttle(()=>{const i=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);i>n&&(n=i,[25,50,75,90].includes(i)&&this.track("scroll_milestone",{scroll_percent:i}))},1e3));let i=0;setInterval(()=>{i+=10,[30,60,120,300].includes(i)&&this.track("time_milestone",{seconds_on_page:i})},1e4),this.setupExitTracking()},setupExitTracking:function(){let n=!1;e.addEventListener("mouseleave",i=>{i.clientY<=0&&!n&&(n=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100)}))})},trackPurchase:function(t){this.track("purchase",{order_id:t.orderId,total_value:t.totalValue,currency:t.currency||"BRL",items:t.items,coupon_code:t.couponCode,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null")})},trackCustomEvent:function(t,e){this.track(t,e)},throttle:function(t,e){let n;return function(){const i=arguments;n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}}};t.InfluencerTracker=InfluencerTracker,t.InfluencerTracker.ConsentManager=i,t.InfluencerTracker.IdGenerator=o,t.InfluencerTracker.InfluencerDetector=c,t.InfluencerTracker.DeviceFingerprint=a,t.InfluencerTracker.EventQueue=r}(t,e),function(t,e){const n={initialized:!1,startTime:Date.now(),lastCartState:null,lastScrollPercent:0,timeOnPage:0,exitTracked:!1,checkoutStartTime:null,checkoutSteps:[],currentStep:null,checkoutSessionData:{},formInteractions:{},abandonmentTracked:!1,init:function(){this.initialized||(console.log("üîÑ Inicializando Hybrid Shopify Tracker"),this.setupUniversalEcommerce(),this.setupBehavioralTracking(),this.setupShopifySpecific(),this.setupAdvancedCheckoutTracking(),this.initializeState(),this.initialized=!0,console.log("‚úÖ Hybrid Shopify Tracker inicializado com checkout tracking"))},setupUniversalEcommerce:function(){console.log("üõí Configurando tracking de ecommerce universal"),this.interceptShopifyAPIs(),this.listenToShopifyEvents(),this.setupSmartPolling()},interceptShopifyAPIs:function(){const e=this,n=t.fetch;t.fetch=async function(...t){const i=await n.apply(this,t);if(i.ok){const n="string"==typeof t[0]?t[0]:t[0].url;try{if(n.includes("/cart")){const t=i.clone();if(n.includes("/cart/add")){const i=await t.json();e.handleCartAdd(i,n)}else if(n.includes("/cart/update")||n.includes("/cart/change")){const i=await t.json();e.handleCartUpdate(i,n)}else if(n.includes("/cart/clear"))e.handleCartClear(n);else if(n.includes("/cart.js")||n.endsWith("/cart")){const i=await t.json();e.handleCartData(i,n)}}if(n.includes("/products/")&&n.includes(".js")){const t=await clonedResponse.json();e.handleProductData(t,n)}if(n.includes("/checkout")||n.includes("/orders")){const t=i.headers.get("content-type");if(t&&t.includes("application/json")){const t=await clonedResponse.json();e.handleCheckoutData(t,n)}}}catch(t){console.log("üîÑ Erro ao processar resposta:",t)}}return i};const i=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,n,...o){return n.includes("/cart")&&this.addEventListener("load",function(){if(this.status>=200&&this.status<300)try{const t=JSON.parse(this.responseText);n.includes("/cart/add")?e.handleCartAdd(t,n):n.includes("/cart/update")||n.includes("/cart/change")?e.handleCartUpdate(t,n):n.includes("/cart.js")&&e.handleCartData(t,n)}catch(t){}}),i.apply(this,[t,n,...o])},console.log("‚úÖ Intercepta√ß√£o de APIs configurada")},listenToShopifyEvents:function(){["cart:updated","cart:added","cart:removed","cart:changed","product:added-to-cart","ajaxCart:updated","drawer:updated"].forEach(t=>{e.addEventListener(t,e=>{console.log(`üõí Evento Shopify detectado: ${t}`),setTimeout(()=>{this.refreshCartState("shopify_event",t,e.detail)},300)})}),t.jQuery&&(0,t.jQuery)(e).on("cart.requestComplete",(t,e)=>{console.log("üõí Evento jQuery cart.requestComplete"),this.handleCartData(e,"jquery_event")})},setupSmartPolling:function(){let t=3e4;const n=async()=>{try{const t=await fetch("/cart.js");if(t.ok){const e=await t.json();this.handleCartData(e,"polling")}}catch(t){console.log("üîÑ Erro no polling:",t)}};setInterval(()=>{const i=e.hasFocus()&&!e.hidden;t=i?2e4:6e4,n()},t),console.log("‚úÖ Polling inteligente configurado")},handleCartAdd:function(t,e){console.log("üõí Produto adicionado ao carrinho:",t),this.track("cart_add",{product_id:t.product_id,variant_id:t.variant_id||t.id,quantity:t.quantity||1,price:t.price?t.price/100:null,title:t.title||t.product_title,vendor:t.vendor,product_type:t.product_type,api_endpoint:e,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_add"),500)},handleCartUpdate:function(t,e){console.log("üõí Carrinho atualizado:",t),this.track("cart_update_action",{updates:t.updates||t,api_endpoint:e,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_update"),500)},handleCartClear:function(t){console.log("üõí Carrinho limpo"),this.track("cart_clear",{api_endpoint:t,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_clear"),500)},handleCartData:function(t,e){const n={items:t.item_count||0,total:t.total_price?t.total_price/100:0,currency:t.currency||"USD",token:t.token};if(!this.lastCartState||n.items!==this.lastCartState.items||Math.abs(n.total-this.lastCartState.total)>.01){console.log("üõí Estado do carrinho mudou:",this.lastCartState,"‚Üí",n);const i=this.determineChangeType(this.lastCartState,n);this.track("cart_update",{cart_items:n.items,cart_value:n.total,cart_currency:n.currency,cart_token:n.token,previous_items:this.lastCartState?.items||0,previous_value:this.lastCartState?.total||0,change_type:i,change_trigger:e,items_detail:t.items?t.items.map(t=>({product_id:t.product_id,variant_id:t.variant_id,quantity:t.quantity,price:t.price/100,line_price:t.line_price/100,title:t.title,vendor:t.vendor,product_type:t.product_type,handle:t.handle,sku:t.sku,grams:t.grams,properties:t.properties})):[],total_discount:t.total_discount?t.total_discount/100:0,discounts:t.cart_level_discount_applications||[],cart_note:t.note,cart_attributes:t.attributes||{},timestamp:Date.now()}),this.lastCartState=n}},handleProductData:function(t,e){console.log("üì¶ Dados de produto carregados:",t),this.track("product_data_loaded",{product_id:t.id,product_handle:t.handle,product_title:t.title,product_type:t.product_type,vendor:t.vendor,price_min:t.price_min/100,price_max:t.price_max/100,available:t.available,variants_count:t.variants?t.variants.length:0,images_count:t.images?t.images.length:0,tags:t.tags||[],api_endpoint:e,timestamp:Date.now()})},handleCheckoutData:function(t,e){console.log("üí≥ Dados de checkout:",t),this.track("checkout_data",{checkout_data:t,api_endpoint:e,timestamp:Date.now()})},setupBehavioralTracking:function(){console.log("üë§ Configurando tracking comportamental"),this.trackScrollBehavior(),this.trackTimeOnPage(),this.trackExitIntent(),this.trackClickBehavior(),this.trackFormInteractions(),this.trackPageVisibility()},trackScrollBehavior:function(){t.addEventListener("scroll",this.throttle(()=>{const n=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);if(n>this.lastScrollPercent&&(this.lastScrollPercent=n,[25,50,75,90].includes(n))){const i={scroll_percent:n,scroll_depth:t.scrollY,page_height:e.body.scrollHeight,viewport_height:t.innerHeight,timestamp:Date.now()};this.track("scroll_milestone",i),this.saveScrollMilestone(i)}},1e3))},trackTimeOnPage:function(){setInterval(()=>{this.timeOnPage+=10,[30,60,120,300,600].includes(this.timeOnPage)&&this.track("time_milestone",{seconds_on_page:this.timeOnPage,minutes_on_page:Math.round(this.timeOnPage/60),is_active:e.hasFocus(),timestamp:Date.now()})},1e4)},trackExitIntent:function(){e.addEventListener("mouseleave",n=>{n.clientY<=0&&!this.exitTracked&&(this.exitTracked=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:this.lastScrollPercent,page_url:t.location.href,referrer:e.referrer,timestamp:Date.now()}))})},trackClickBehavior:function(){e.addEventListener("click",this.throttle(t=>{const e=t.target;let n="generic";e.matches('a[href*="/products/"]')?n="product_link":e.matches('button[name="add"], input[name="add"]')?n="add_to_cart_button":e.matches('a[href*="/cart"], button[data-cart]')?n="cart_link":e.matches('a[href*="/checkout"]')&&(n="checkout_link");const i={click_type:n,element_tag:e.tagName,element_class:e.className,element_id:e.id,element_text:e.textContent?.substring(0,100),href:e.href,position_x:t.clientX,position_y:t.clientY,timestamp:Date.now()};this.track("click_event",i),this.saveInteraction({type:"click",...i})},500))},trackFormInteractions:function(){e.addEventListener("submit",t=>{const e=t.target;let n="generic";e.action&&e.action.includes("/cart/add")?n="add_to_cart":e.action&&e.action.includes("/contact")?n="contact":e.querySelector('input[type="email"]')&&(n="newsletter"),this.track("form_submit",{form_type:n,form_action:e.action,form_method:e.method,fields_count:e.elements.length,timestamp:Date.now()})})},trackPageVisibility:function(){e.addEventListener("visibilitychange",()=>{this.track("page_visibility_change",{is_visible:!e.hidden,time_on_page:Date.now()-this.startTime,timestamp:Date.now()})})},setupShopifySpecific:function(){console.log("üõçÔ∏è Configurando tracking espec√≠fico do Shopify"),this.trackPageType(),this.trackCustomerData(),this.trackShopData(),this.trackVariantSelections()},trackPageType:function(){const n=t.location.pathname;let i="other";n.includes("/products/")?(i="product",this.trackProductView()):n.includes("/collections/")?(i="collection",this.trackCollectionView()):n.includes("/cart")?i="cart":n.includes("/checkout")?i="checkout":"/"!==n&&""!==n||(i="home"),this.track("page_view_detailed",{page_type:i,page_path:n,page_title:e.title,referrer:e.referrer,timestamp:Date.now()})},trackProductView:function(){const t=this.extractProductData();t&&(this.track("product_view",{...t,timestamp:Date.now()}),this.saveProductView(t))},trackCollectionView:function(){const t=this.extractCollectionData();t&&this.track("collection_view",{...t,timestamp:Date.now()})},trackVariantSelections:function(){['input[name="id"]','select[name="id"]',"[data-variant-id]",".product-variant-id"].forEach(t=>{e.querySelectorAll(t).forEach(t=>{t.addEventListener("change",()=>{this.track("variant_selection",{product_id:this.getProductId(),variant_id:t.value||t.dataset.variantId,product_handle:this.getProductHandle(),selection_method:t.tagName.toLowerCase(),timestamp:Date.now()})})})})},trackCustomerData:function(){const t=this.extractCustomerData();t&&this.track("customer_data",{...t,timestamp:Date.now()})},trackShopData:function(){const t=this.extractShopData();this.track("shop_data",{...t,timestamp:Date.now()})},refreshCartState:function(t,e=null,n=null){setTimeout(async()=>{try{const e=await fetch("/cart.js");if(e.ok){const n=await e.json();this.handleCartData(n,t)}}catch(t){console.log("üîÑ Erro ao atualizar estado do carrinho:",t)}},300)},determineChangeType:function(t,e){return t?e.items>t.items?"add":e.items<t.items?"remove":Math.abs(e.total-t.total)>.01?"update":"unknown":"initial"},extractProductData:function(){const n={};if(t.product?(n.product_id=t.product.id,n.product_handle=t.product.handle,n.product_title=t.product.title,n.product_type=t.product.type,n.vendor=t.product.vendor,n.price=t.product.price/100,n.available=t.product.available,n.variants_count=t.product.variants?.length||0):t.meta?.product&&(n.product_id=t.meta.product.id,n.product_handle=t.meta.product.handle),!n.product_id){const t=e.querySelector('meta[property="product:retailer_item_id"]');t&&(n.product_id=t.content)}return Object.keys(n).length>0?n:null},extractCollectionData:function(){const e={};return t.collection&&(e.collection_id=t.collection.id,e.collection_handle=t.collection.handle,e.collection_title=t.collection.title,e.products_count=t.collection.products_count),Object.keys(e).length>0?e:null},extractCustomerData:function(){const e={};return t.customer?(e.customer_id=t.customer.id,e.customer_email=t.customer.email,e.customer_tags=t.customer.tags,e.orders_count=t.customer.orders_count,e.total_spent=t.customer.total_spent):t.Shopify?.customer&&(e.customer_id=t.Shopify.customer.id,e.customer_email=t.Shopify.customer.email),Object.keys(e).length>0?e:null},extractShopData:function(){return{shop_domain:t.Shopify?.shop||t.shopifyData?.shop?.domain,shop_currency:t.Shopify?.currency?.active||t.shopifyData?.shop?.currency,shop_money_format:t.Shopify?.money_format,shop_locale:t.Shopify?.locale}},getProductId:function(){if(t.product?.id)return t.product.id;if(t.meta?.product?.id)return t.meta.product.id;const n=e.querySelector('meta[property="product:retailer_item_id"]');return n?n.content:null},getProductHandle:function(){if(t.product?.handle)return t.product.handle;const e=t.location.pathname.split("/");return e[e.length-1]||null},initializeState:function(){fetch("/cart.js").then(t=>t.json()).then(t=>{this.lastCartState={items:t.item_count||0,total:t.total_price?t.total_price/100:0,currency:t.currency||"USD",token:t.token},console.log("üõí Estado inicial do carrinho:",this.lastCartState)}).catch(t=>{console.log("‚ö†Ô∏è Erro ao carregar estado inicial do carrinho:",t),this.lastCartState={items:0,total:0,currency:"USD",token:null}}),this.savePageVisit({page_type:this.detectPageType(),referrer:e.referrer}),this.checkForAbandonedCheckout(),console.log("‚úÖ Estado inicial configurado")},detectPageType:function(){const e=t.location.pathname;return e.includes("/products/")?"product":e.includes("/collections/")?"collection":e.includes("/cart")?"cart":e.includes("/checkout")?"checkout":e.includes("/thank_you")||e.includes("/orders/")?"thank_you":"/"===e||""===e?"home":"other"},getInfluencerAttribution:function(){try{return JSON.parse(sessionStorage.getItem("inf_attribution")||"null")}catch(t){return null}},getCustomerJourney:function(){return{session_start:this.startTime,pages_visited:this.getPagesVisited(),products_viewed:this.getProductsViewed(),time_on_site:Date.now()-this.startTime,scroll_milestones:this.getScrollMilestones(),interactions:this.getInteractionHistory()}},getPagesVisited:function(){try{return JSON.parse(sessionStorage.getItem("pages_visited")||"[]")}catch(t){return[]}},getProductsViewed:function(){try{return JSON.parse(sessionStorage.getItem("products_viewed")||"[]")}catch(t){return[]}},getScrollMilestones:function(){try{return JSON.parse(sessionStorage.getItem("scroll_milestones")||"[]")}catch(t){return[]}},getInteractionHistory:function(){try{return JSON.parse(sessionStorage.getItem("interaction_history")||"[]")}catch(t){return[]}},track:function(e,n={}){t.InfluencerTracker&&t.InfluencerTracker.track?t.InfluencerTracker.track(e,n):console.log("üìä Evento rastreado:",e,n)},enrichEvent:function(t,e){return{...this.extractShopData(),...this.extractCustomerData(),platform_version:"hybrid",tracking_method:"universal_api"}},throttle:function(t,e){let n;return function(){const i=arguments;n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}},savePageVisit:function(n){try{const i=this.getPagesVisited();i.push({url:t.location.href,title:e.title,timestamp:Date.now(),...n}),sessionStorage.setItem("pages_visited",JSON.stringify(i.slice(-50)))}catch(t){console.log("Erro ao salvar visita de p√°gina:",t)}},saveProductView:function(t){try{const e=this.getProductsViewed();e.push({timestamp:Date.now(),...t}),sessionStorage.setItem("products_viewed",JSON.stringify(e.slice(-20)))}catch(t){console.log("Erro ao salvar visualiza√ß√£o de produto:",t)}},saveScrollMilestone:function(e){try{const n=this.getScrollMilestones();n.push({timestamp:Date.now(),page:t.location.href,...e}),sessionStorage.setItem("scroll_milestones",JSON.stringify(n.slice(-100)))}catch(t){console.log("Erro ao salvar milestone de scroll:",t)}},saveInteraction:function(e){try{const n=this.getInteractionHistory();n.push({timestamp:Date.now(),page:t.location.href,...e}),sessionStorage.setItem("interaction_history",JSON.stringify(n.slice(-200)))}catch(t){console.log("Erro ao salvar intera√ß√£o:",t)}},setupAdvancedCheckoutTracking:function(){console.log("üí≥ Configurando checkout tracking avan√ßado"),this.isCheckoutPage()&&this.initCheckoutTracking(),this.monitorCheckoutNavigation(),this.isThankYouPage()&&this.handlePurchaseCompletion()},isCheckoutPage:function(){return t.location.pathname.includes("/checkout")||t.location.pathname.includes("/checkouts/")||e.querySelector(".checkout, #checkout, [data-checkout]")||e.querySelector('body.checkout, body[class*="checkout"]')},isThankYouPage:function(){return t.location.pathname.includes("/thank_you")||t.location.pathname.includes("/orders/")||e.querySelector(".order-confirmation, .thank-you, [data-order-confirmation]")},monitorCheckoutNavigation:function(){e.addEventListener("click",t=>{const e=t.target;this.isCheckoutButton(e)&&this.track("checkout_button_clicked",{button_text:e.textContent?.trim(),button_location:this.getElementLocation(e),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),influencer_attribution:this.getInfluencerAttribution(),timestamp:Date.now()})});let n=t.location.href;new MutationObserver(()=>{const e=t.location.href;e!==n&&(this.isCheckoutPage()&&!n.includes("/checkout")&&setTimeout(()=>this.initCheckoutTracking(),500),n=e)}).observe(e,{subtree:!0,childList:!0})},isCheckoutButton:function(t){const e=t.textContent?.toLowerCase()||"",n=t.className?.toLowerCase()||"",i=t.id?.toLowerCase()||"";return["checkout","finalizar","comprar","buy now","purchase"].some(t=>e.includes(t)||n.includes(t)||i.includes(t))||t.matches('[href*="/checkout"], [data-checkout], .checkout-btn, .btn-checkout')},initCheckoutTracking:function(){this.checkoutStartTime||(console.log("üí≥ Inicializando tracking de checkout"),this.checkoutStartTime=Date.now(),this.checkoutSteps=[],this.currentStep=this.detectCheckoutStep(),this.checkoutSessionData=this.initCheckoutSession(),this.abandonmentTracked=!1,this.track("checkout_started",{checkout_id:this.generateCheckoutId(),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),cart_details:this.getCartDetails(),influencer_attribution:this.getInfluencerAttribution(),customer_journey:this.getCustomerJourney(),entry_method:this.getCheckoutEntryMethod(),device_info:this.getDeviceInfo(),initial_step:this.currentStep,timestamp:Date.now()}),this.saveCheckoutSession(),this.monitorCheckoutSteps(),this.monitorCheckoutForms(),this.monitorCheckoutAbandonment(),this.monitorCheckoutPerformance(),console.log("‚úÖ Checkout tracking ativo para step:",this.currentStep))},initCheckoutSession:function(){return{checkout_id:this.generateCheckoutId(),start_time:Date.now(),steps_data:{},form_interactions:{},performance_metrics:{},user_behavior:{scroll_events:[],click_events:[],focus_events:[]}}},generateCheckoutId:function(){return"checkout_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},detectCheckoutStep:function(){if(e.querySelector('[data-step="contact"], [data-checkout-step="contact"]'))return"contact";if(e.querySelector('[data-step="shipping"], [data-checkout-step="shipping"]'))return"shipping";if(e.querySelector('[data-step="payment"], [data-checkout-step="payment"]'))return"payment";if(e.querySelector('[data-step="review"], [data-checkout-step="review"]'))return"review";if(e.querySelector(".step-contact, .checkout-step-contact"))return"contact";if(e.querySelector(".step-shipping, .checkout-step-shipping"))return"shipping";if(e.querySelector(".step-payment, .checkout-step-payment"))return"payment";if(e.querySelector(".step-review, .checkout-step-review"))return"review";if(e.querySelector('input[name="email"], #email'))return"contact";if(e.querySelector('select[name="country"], input[name="address1"]'))return"shipping";if(e.querySelector('input[name="number"], [data-payment]'))return"payment";const n=t.location.href;if(n.includes("contact"))return"contact";if(n.includes("shipping"))return"shipping";if(n.includes("payment"))return"payment";if(n.includes("review"))return"review";const i=e.querySelector(".breadcrumb .active, .checkout-nav .active, .step.active");if(i){const t=i.textContent?.toLowerCase()||"";if(t.includes("contact")||t.includes("information"))return"contact";if(t.includes("shipping")||t.includes("delivery"))return"shipping";if(t.includes("payment")||t.includes("billing"))return"payment";if(t.includes("review")||t.includes("confirm"))return"review"}return"unknown"},monitorCheckoutSteps:function(){new MutationObserver(()=>{const t=this.detectCheckoutStep();if(t!==this.currentStep&&"unknown"!==t){const e=Date.now()-this.checkoutStartTime,n=this.currentStep;console.log(`üí≥ Step mudou: ${n} ‚Üí ${t}`),n&&"unknown"!==n&&(this.track("checkout_step_completed",{checkout_id:this.checkoutSessionData.checkout_id,step:n,next_step:t,time_on_step:e,step_data:this.getStepData(n),form_interactions:this.formInteractions[n]||{},step_performance:this.getStepPerformance(n),timestamp:Date.now()}),this.checkoutSteps.push({step:n,time_spent:e,completed:!0,data:this.getStepData(n)})),this.track("checkout_step_started",{checkout_id:this.checkoutSessionData.checkout_id,step:t,previous_step:n,total_time_in_checkout:Date.now()-this.checkoutSessionData.start_time,timestamp:Date.now()}),this.currentStep=t,this.checkoutStartTime=Date.now(),this.formInteractions[t]={},this.saveCheckoutSession()}}).observe(e.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-step","data-checkout-step"]})},monitorCheckoutForms:function(){console.log("üìù Monitorando intera√ß√µes com formul√°rios"),e.querySelectorAll("input, select, textarea").forEach(t=>{this.setupFieldMonitoring(t)}),new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&t.querySelectorAll("input, select, textarea").forEach(t=>this.setupFieldMonitoring(t))})})}).observe(e.body,{childList:!0,subtree:!0})},setupFieldMonitoring:function(t){if(t.dataset.trackerMonitored)return;t.dataset.trackerMonitored="true";const e=t.name||t.id||t.placeholder||"unknown",n=t.type||t.tagName.toLowerCase();let i={field_name:e,field_type:n,focus_count:0,input_count:0,total_focus_time:0,value_changes:0,focus_start:null,initial_value:t.value,error_count:0};t.addEventListener("focus",()=>{i.focus_count++,i.focus_start=Date.now(),this.track("checkout_field_focus",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,focus_count:i.focus_count,timestamp:Date.now()})}),t.addEventListener("blur",()=>{if(i.focus_start){const o=Date.now()-i.focus_start;i.total_focus_time+=o,i.focus_start=null,this.track("checkout_field_blur",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,focus_time:o,total_focus_time:i.total_focus_time,has_value:!!t.value,timestamp:Date.now()})}}),t.addEventListener("input",()=>{i.input_count++,t.value!==i.initial_value&&i.value_changes++,this.throttledTrackInput(t,i)}),t.addEventListener("change",()=>{this.track("checkout_field_change",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,new_value:"select-one"===n?t.value:"[hidden]",timestamp:Date.now()})}),setInterval(()=>{(t.classList.contains("error")||t.classList.contains("invalid")||"true"===t.getAttribute("aria-invalid")||t.closest(".error, .invalid, [data-error]"))&&(i.error_count++,this.track("checkout_field_error",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,error_count:i.error_count,timestamp:Date.now()}))},2e3),this.formInteractions[this.currentStep]||(this.formInteractions[this.currentStep]={}),this.formInteractions[this.currentStep][e]=i},throttledTrackInput:(()=>{const t=new Map;return function(e,n){const i=n.field_name;t.has(i)&&clearTimeout(t.get(i)),t.set(i,setTimeout(()=>{this.track("checkout_field_input",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:i,field_type:n.field_type,input_count:n.input_count,value_changes:n.value_changes,has_value:!!e.value,value_length:e.value?.length||0,timestamp:Date.now()}),t.delete(i)},1e3))}})(),monitorCheckoutAbandonment:function(){let n;console.log("üö™ Monitorando abandono de checkout"),t.addEventListener("beforeunload",t=>{!this.abandonmentTracked&&this.isCheckoutPage()&&this.trackCheckoutAbandonment("page_unload")}),e.addEventListener("mouseleave",t=>{t.clientY<=0&&!this.abandonmentTracked&&this.isCheckoutPage()&&this.track("checkout_exit_intent",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,time_in_checkout:Date.now()-this.checkoutSessionData.start_time,time_on_current_step:Date.now()-this.checkoutStartTime,form_completion:this.calculateFormCompletion(),timestamp:Date.now()})});const i=()=>{clearTimeout(n),n=setTimeout(()=>{this.isCheckoutPage()&&!this.abandonmentTracked&&this.track("checkout_inactivity",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,inactivity_duration:3e5,timestamp:Date.now()})},3e5)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(t=>{e.addEventListener(t,i,{passive:!0})}),i()},trackCheckoutAbandonment:function(t){this.abandonmentTracked||(this.abandonmentTracked=!0,console.log("üö™ Checkout abandonado:",t),this.track("checkout_abandonment",{checkout_id:this.checkoutSessionData.checkout_id,abandonment_reason:t,abandonment_step:this.currentStep,time_in_checkout:Date.now()-this.checkoutSessionData.start_time,time_on_current_step:Date.now()-this.checkoutStartTime,steps_completed:this.checkoutSteps,form_completion:this.calculateFormCompletion(),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),influencer_attribution:this.getInfluencerAttribution(),customer_journey:this.getCustomerJourney(),device_info:this.getDeviceInfo(),performance_metrics:this.getCheckoutPerformanceMetrics(),timestamp:Date.now()}),this.saveAbandonmentData())},monitorCheckoutPerformance:function(){"PerformanceObserver"in t&&new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"navigation"===t.entryType&&(this.checkoutSessionData.performance_metrics.page_load={load_time:t.loadEventEnd-t.loadEventStart,dom_content_loaded:t.domContentLoadedEventEnd-t.domContentLoadedEventStart,first_paint:t.responseEnd-t.requestStart})})}).observe({entryTypes:["navigation"]});const e=t.fetch;t.fetch=async function(...t){const n=Date.now(),i=await e.apply(this,t),o=Date.now();return t[0]&&"string"==typeof t[0]&&t[0].includes("checkout")&&this.track("checkout_api_request",{checkout_id:this.checkoutSessionData.checkout_id,url:t[0],method:t[1]?.method||"GET",duration:o-n,status:i.status,step:this.currentStep,timestamp:Date.now()}),i}.bind(this)},handlePurchaseCompletion:function(){console.log("üéâ Purchase completed - coletando dados finais");const t=this.extractOrderData(),e=this.getCheckoutSession();this.track("purchase_completed_detailed",{...t,checkout_session:e,customer_journey:this.getCustomerJourney(),influencer_attribution:this.getInfluencerAttribution(),total_checkout_time:e?Date.now()-e.start_time:null,device_info:this.getDeviceInfo(),timestamp:Date.now()}),this.clearCheckoutSession()},getStepData:function(t){const e={};try{switch(t){case"contact":e.email=this.getFieldValue("email"),e.phone=this.getFieldValue("phone"),e.newsletter_signup=this.getCheckboxValue("newsletter");break;case"shipping":e.shipping_method=this.getSelectedShippingMethod(),e.address_country=this.getFieldValue("country"),e.address_state=this.getFieldValue("province"),e.address_city=this.getFieldValue("city"),e.shipping_price=this.getShippingPrice();break;case"payment":e.payment_method=this.getSelectedPaymentMethod(),e.billing_same_as_shipping=this.getCheckboxValue("billing_same_as_shipping")}}catch(t){console.log("Erro ao extrair dados do step:",t)}return e},getFieldValue:function(t){const n=[`input[name="${t}"]`,`select[name="${t}"]`,`textarea[name="${t}"]`,`#${t}`,`input[name*="${t}"]`,`select[name*="${t}"]`];for(const t of n){const n=e.querySelector(t);if(n)return n.value||null}return null},getCheckboxValue:function(t){const n=e.querySelector(`input[name="${t}"], input[name*="${t}"], #${t}`);return n?n.checked:null},getSelectedShippingMethod:function(){const t=e.querySelector('input[name*="shipping"]:checked, select[name*="shipping"] option:checked');return t?t.value||t.textContent:null},getSelectedPaymentMethod:function(){const t=e.querySelector('input[name*="payment"]:checked, select[name*="payment"] option:checked');return t?t.value||t.textContent:null},getShippingPrice:function(){const t=e.querySelector(".shipping-price, [data-shipping-price], .delivery-price");if(t){const e=t.textContent,n=parseFloat(e.replace(/[^0-9.,]/g,"").replace(",","."));return isNaN(n)?null:n}return null},calculateFormCompletion:function(){const t=e.querySelectorAll('input:not([type="hidden"]), select, textarea'),n=Array.from(t).filter(t=>t.value&&""!==t.value.trim());return t.length>0?Math.round(n.length/t.length*100):0},getStepPerformance:function(t){return{api_requests:this.checkoutSessionData.performance_metrics.api_requests||0,load_time:this.checkoutSessionData.performance_metrics.load_time||null,form_interactions:Object.keys(this.formInteractions[t]||{}).length}},getCheckoutEntryMethod:function(){const t=e.referrer;return t.includes("/cart")?"cart_page":t.includes("/products/")?"product_page":t.includes("/collections/")?"collection_page":t.includes("checkout")?"direct_checkout":t?"unknown":"direct_url"},getCartDetails:function(){try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status){const e=JSON.parse(t.responseText);return{items:e.items.map(t=>({product_id:t.product_id,variant_id:t.variant_id,quantity:t.quantity,price:t.price/100,title:t.title})),total_discount:e.total_discount/100,currency:e.currency}}}catch(t){console.log("Erro ao obter detalhes do carrinho:",t)}return null},getDeviceInfo:function(){return{user_agent:navigator.userAgent,screen_resolution:`${screen.width}x${screen.height}`,viewport_size:`${t.innerWidth}x${t.innerHeight}`,device_pixel_ratio:t.devicePixelRatio,connection:navigator.connection?{effective_type:navigator.connection.effectiveType,downlink:navigator.connection.downlink}:null,touch_support:"ontouchstart"in t}},getCheckoutPerformanceMetrics:function(){return this.checkoutSessionData.performance_metrics||{}},extractOrderData:function(){const n={};if(t.Shopify?.checkout&&(n.order_id=t.Shopify.checkout.order_id,n.order_number=t.Shopify.checkout.order_number,n.total_price=t.Shopify.checkout.total_price/100,n.currency=t.Shopify.checkout.currency,n.customer_id=t.Shopify.checkout.customer_id),!n.order_id){const t=e.querySelector(".order-number, [data-order-number], .order-id");t&&(n.order_number=t.textContent?.trim())}return n},getElementLocation:function(e){const n=e.getBoundingClientRect();return{x:n.left,y:n.top,width:n.width,height:n.height,viewport_position:{x_percent:Math.round(n.left/t.innerWidth*100),y_percent:Math.round(n.top/t.innerHeight*100)}}},saveCheckoutSession:function(){try{sessionStorage.setItem("checkout_session",JSON.stringify(this.checkoutSessionData))}catch(t){console.log("Erro ao salvar sess√£o de checkout:",t)}},getCheckoutSession:function(){try{return JSON.parse(sessionStorage.getItem("checkout_session")||"null")}catch(t){return null}},clearCheckoutSession:function(){try{sessionStorage.removeItem("checkout_session")}catch(t){console.log("Erro ao limpar sess√£o de checkout:",t)}},saveAbandonmentData:function(){const t={checkout_id:this.checkoutSessionData.checkout_id,abandonment_time:Date.now(),step:this.currentStep,cart_value:this.getCartValue(),form_completion:this.calculateFormCompletion(),influencer_attribution:this.getInfluencerAttribution()};try{localStorage.setItem("checkout_abandonment",JSON.stringify(t))}catch(t){console.log("Erro ao salvar dados de abandono:",t)}},checkForAbandonedCheckout:function(){try{const e=JSON.parse(localStorage.getItem("checkout_abandonment")||"null");if(e){const n=Date.now()-e.abandonment_time;n<864e5?(this.track("checkout_recovery_opportunity",{original_checkout_id:e.checkout_id,time_since_abandonment:n,abandoned_step:e.step,abandoned_cart_value:e.cart_value,recovery_page:t.location.href,timestamp:Date.now()}),this.isCheckoutPage()&&(this.track("checkout_recovery_attempt",{original_checkout_id:e.checkout_id,time_since_abandonment:n,timestamp:Date.now()}),localStorage.removeItem("checkout_abandonment"))):localStorage.removeItem("checkout_abandonment")}}catch(t){console.log("Erro ao verificar checkout abandonado:",t)}}};t.shopifyAdapter=n,console.log("üîÑ Hybrid Shopify Tracker carregado")}(t,e),function(t,e){const n={sessionStart:Date.now(),behaviorMetrics:{pageViews:0,productViews:0,cartActions:0,totalClicks:0,scrollDepth:[],timeOnPages:[]},analyzeBehavior:function(){const t=Date.now()-this.sessionStart,e=this.behaviorMetrics;return{behavioral_segment:this.getBehavioralSegment(e,t),conversion_probability:this.getConversionProbability(e,t),engagement_quality:this.getEngagementQuality(e,t),device_tier:this.getDeviceTier(),attribution_confidence:this.getAttributionConfidence()}},getBehavioralSegment:function(t,e){return t.cartActions>0&&e<3e5?"decisive_buyer":t.cartActions>2?"hesitant_buyer":t.productViews>5&&0===t.cartActions?"researcher":t.totalClicks>10?"price_conscious":"casual_browser"},getConversionProbability:function(t,e){let n=0;return t.cartActions>0&&(n+=40),t.productViews>3&&(n+=20),e>18e4&&(n+=20),t.totalClicks>5&&(n+=10),t.pageViews>5&&(n+=10),n>=70?"high":n>=40?"medium":"low"},getEngagementQuality:function(t,e){const n=t.scrollDepth.length>0?t.scrollDepth.reduce((t,e)=>t+e,0)/t.scrollDepth.length:0;let i=0;return i+=5*t.pageViews,i+=e/1e3*.1,i+=2*t.totalClicks,i+=.5*n,i>=100?"high":i>=50?"medium":"low"},getDeviceTier:function(){const e=navigator.deviceMemory||4,n=navigator.hardwareConcurrency||4,i=t.screen,o=i.width*i.height;return e>=8&&n>=8&&o>2073600?"premium":e>=4&&o>921600?"mid_range":"budget"},getAttributionConfidence:function(){let n=.3;const i=new URLSearchParams(t.location.search);return(i.get("affiliate")||i.get("ref"))&&(n+=.4),i.get("utm_source")&&(n+=.2),e.referrer&&["instagram.com","tiktok.com","youtube.com","facebook.com"].some(t=>e.referrer.includes(t))&&(n+=.1),Math.min(n,1)},updateMetrics:function(t,e){switch(t){case"page_view":this.behaviorMetrics.pageViews++;break;case"product_view":case"product_impression":this.behaviorMetrics.productViews++;break;case"cart_update":this.behaviorMetrics.cartActions++;break;case"scroll_milestone":e&&e.scroll_percent&&this.behaviorMetrics.scrollDepth.push(e.scroll_percent);break;case"variant_selection":case"product_impression":this.behaviorMetrics.totalClicks++}},sendAnalysis:function(){const e=this.analyzeBehavior();t.InfluencerTracker&&t.InfluencerTracker.track("ai_session_analysis",{session_analysis:e,session_duration:Date.now()-this.sessionStart,total_events:Object.values(this.behaviorMetrics).reduce((t,e)=>Array.isArray(e)?t+e.length:t+e,0)})}};if(t.InfluencerTracker){const e=t.InfluencerTracker.track;t.InfluencerTracker.track=function(t,i={}){n.updateMetrics(t,i),e.call(this,t,i)},t.InfluencerTracker.getAIAnalysis=function(){return n.analyzeBehavior()}}setInterval(()=>{n.sendAnalysis()},3e5),t.addEventListener("beforeunload",()=>{n.sendAnalysis()}),t.AISessionAnalyzer=n,console.log("ü§ñ AI Session Analyzer integrated with existing customer_sessions")}(t,e),function(t){t.InfluencerTrackerUtils={debounce:function(t,e,n){let i;return function(){const o=this,c=arguments,a=n&&!i;clearTimeout(i),i=setTimeout(function(){i=null,n||t.apply(o,c)},e),a&&t.apply(o,c)}},throttle:function(t,e){let n;return function(){const i=arguments;n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:Math.round(e.left),y:Math.round(e.top),width:Math.round(e.width),height:Math.round(e.height)}},parseCurrency:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const n=parseFloat(e);return n>1e4?n/100:isNaN(n)?null:n},isElementVisible:function(n){const i=n.getBoundingClientRect();return i.top>=0&&i.left>=0&&i.bottom<=(t.innerHeight||e.documentElement.clientHeight)&&i.right<=(t.innerWidth||e.documentElement.clientWidth)},getScrollPercentage:function(){const n=t.pageYOffset||e.documentElement.scrollTop,i=e.documentElement.scrollHeight-t.innerHeight;return Math.round(n/i*100)},setCookie:function(t,n,i){const o=i?`; expires=${new Date(Date.now()+864e5*i).toUTCString()}`:"";e.cookie=`${t}=${n}${o}; path=/`},getCookie:function(t){return e.cookie.split("; ").reduce((e,n)=>{const i=n.split("=");return i[0]===t?decodeURIComponent(i[1]):e},"")},setStorage:function(t,e,n=!1){try{return(n?sessionStorage:localStorage).setItem(t,JSON.stringify(e)),!0}catch(i){return console.warn("Storage not available, using cookie fallback"),this.setCookie(t,JSON.stringify(e),n?null:30),!1}},getStorage:function(t,e=!1){try{const n=(e?sessionStorage:localStorage).getItem(t);return n?JSON.parse(n):null}catch(e){const n=this.getCookie(t);return n?JSON.parse(n):null}}}}(t)}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:{});