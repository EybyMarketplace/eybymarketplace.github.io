/* Influencer Tracker v2.1.0 with AI | Built: 2025-09-01T19:49:09.994Z */
!function(t,e,r){"use strict";void 0!==t&&(t.InfluencerTrackerBuild={name:"full",version:"2.1.0",timestamp:"2025-09-01T19:49:10.001Z",files:["src/core/tracker-core.js","src/adapters/shopify-adapter.js","src/ai/ai-data-collector.js","src/utils/helpers.js"],features:{tracking:!0,attribution:!0,adapters:!0,ai:!0}}),function(t,e){const r={apiEndpoint:"",projectId:"",enableConsentCheck:!0,batchSize:10,batchTimeout:3e3,sessionTimeout:18e5,version:"2.0.0"},n={checkConsent:function(){return!r.enableConsentCheck||"granted"===localStorage.getItem("analytics_consent")},waitForConsent:function(t){const e=setInterval(()=>{this.checkConsent()&&(clearInterval(e),t())},500);setTimeout(()=>{clearInterval(e)},1e4)}},i={generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},getUserId:function(){let t=localStorage.getItem("inf_user_id");return t||(t=this.generateUUID(),localStorage.setItem("inf_user_id",t)),t},getSessionId:function(){let t=sessionStorage.getItem("inf_session");if(t){const e=JSON.parse(t),n=Date.now();if(n-e.lastActivity<r.sessionTimeout)return e.lastActivity=n,sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}const e={id:this.generateUUID(),startTime:Date.now(),lastActivity:Date.now()};return sessionStorage.setItem("inf_session",JSON.stringify(e)),e.id}},a={detectInfluencer:function(){const r=new URLSearchParams(t.location.search),n=new URLSearchParams(t.location.hash.substring(1)),i={influencer_id:r.get("inf_id")||r.get("influencer")||n.get("inf_id"),campaign_id:r.get("camp_id")||r.get("campaign")||n.get("camp_id"),promo_code:r.get("promo")||r.get("codigo")||n.get("promo"),utm_source:r.get("utm_source"),utm_medium:r.get("utm_medium"),utm_campaign:r.get("utm_campaign"),ref:r.get("ref")},a=e.referrer;let o=null;if(a.includes("instagram.com")?o="instagram":a.includes("tiktok.com")?o="tiktok":a.includes("youtube.com")||a.includes("youtu.be")?o="youtube":a.includes("facebook.com")?o="facebook":(a.includes("twitter.com")||a.includes("x.com"))&&(o="twitter"),Object.values(i).some(t=>null!==t)||o){const e={...i,social_source:o,detected_at:Date.now(),landing_page:t.location.href};return sessionStorage.setItem("inf_attribution",JSON.stringify(e)),e}const c=sessionStorage.getItem("inf_attribution");return c?JSON.parse(c):null}},o={generate:function(){const e=t.screen,r=navigator;return{user_agent:r.userAgent,language:r.language,platform:r.platform,screen_resolution:`${e.width}x${e.height}`,color_depth:e.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,device_memory:r.deviceMemory||null,hardware_concurrency:r.hardwareConcurrency||null,connection:r.connection?{effective_type:r.connection.effectiveType,downlink:r.connection.downlink}:null}}},c={queue:[],add:function(t){this.queue.push(t),this.queue.length>=r.batchSize&&this.flush()},flush:function(){if(0===this.queue.length||!r.apiEndpoint)return;const t=this.queue.splice(0,r.batchSize);fetch(r.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:r.projectId,events:t,version:r.version})}).catch(e=>{console.warn("Influencer Tracker: Failed to send events",e);const r=JSON.parse(localStorage.getItem("inf_failed_events")||"[]");r.push(...t),localStorage.setItem("inf_failed_events",JSON.stringify(r.slice(-100)))})},scheduleFlush:function(){this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=setTimeout(()=>this.flush(),r.batchTimeout)}},InfluencerTracker={initialized:!1,startTime:Date.now(),platform:"generic",adapter:null,init:function(t={}){this.initialized||(Object.assign(r,t),r.apiEndpoint?(this.platform=this.detectPlatform(),console.log(`🎯 Plataforma detectada: ${this.platform}`),this.adapter=this.loadAdapter(this.platform),!r.enableConsentCheck||n.checkConsent()?this.startTracking():n.waitForConsent(()=>this.startTracking())):console.warn("Influencer Tracker: apiEndpoint não configurado"))},detectPlatform:function(){return t.Shopify||t.shopifyData||e.querySelector('meta[name="shopify-checkout-api-token"]')?"shopify":"generic"},loadAdapter:function(e){return t[`${e}Adapter`]||null},startTracking:function(){this.initialized=!0;const r=a.detectInfluencer();this.track("page_view",{page_url:t.location.href,page_title:e.title,referrer:e.referrer,influencer_data:r}),this.setupUniversalTracking(),this.adapter?.init&&this.adapter.init(),c.scheduleFlush(),t.addEventListener("beforeunload",()=>c.flush()),console.log("Influencer Tracker: Inicializado com sucesso")},track:function(e,r={}){if(!this.initialized)return;const n={event_id:i.generateUUID(),event_type:e,timestamp:Date.now(),user_id:i.getUserId(),session_id:i.getSessionId(),page_url:t.location.href,device_fingerprint:o.generate(),platform:this.platform,properties:r};this.adapter?.enrichEvent&&Object.assign(n.properties,this.adapter.enrichEvent(e,r)),c.add(n)},setupUniversalTracking:function(){let r=0;t.addEventListener("scroll",this.throttle(()=>{const n=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);n>r&&(r=n,[25,50,75,90].includes(n)&&this.track("scroll_milestone",{scroll_percent:n}))},1e3));let n=0;setInterval(()=>{n+=10,[30,60,120,300].includes(n)&&this.track("time_milestone",{seconds_on_page:n})},1e4),this.setupExitTracking()},setupExitTracking:function(){let r=!1;e.addEventListener("mouseleave",n=>{n.clientY<=0&&!r&&(r=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100)}))})},trackPurchase:function(t){this.track("purchase",{order_id:t.orderId,total_value:t.totalValue,currency:t.currency||"BRL",items:t.items,coupon_code:t.couponCode,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null")})},trackCustomEvent:function(t,e){this.track(t,e)},throttle:function(t,e){let r;return function(){const n=arguments;r||(t.apply(this,n),r=!0,setTimeout(()=>r=!1,e))}}};t.InfluencerTracker=InfluencerTracker,t.InfluencerTracker.ConsentManager=n,t.InfluencerTracker.IdGenerator=i,t.InfluencerTracker.InfluencerDetector=a,t.InfluencerTracker.DeviceFingerprint=o,t.InfluencerTracker.EventQueue=c}(t,e),function(t,e){t.shopifyAdapter={lastCartState:null,cartUpdateTimeout:null,init:function(){console.log("🛍️ Inicializando adaptador Shopify"),this.setupShopifyTracking(),this.setupCartTracking(),this.setupProductTracking(),this.setupCheckoutTracking(),this.lastCartState={items:this.getCartItemCount(),value:this.getCartValue()},console.log("🛒 Estado inicial do carrinho:",this.lastCartState)},enrichEvent:function(e,r){const n={shop_domain:t.Shopify?.shop||t.shopifyData?.shop?.domain,currency:t.shopifyData?.shop?.currency||"USD",customer_id:t.shopifyData?.customer?.id,cart_token:this.getCartToken()};return"cart_update"===e&&(n.cart_items=this.getCartItemCount(),n.cart_value=this.getCartValue()),"product_view"===e&&t.shopifyData?.product&&(n.product_id=t.shopifyData.product.id,n.product_handle=t.shopifyData.product.handle,n.product_type=t.shopifyData.product.type,n.product_vendor=t.shopifyData.product.vendor,n.product_price=t.shopifyData.product.price,n.product_available=t.shopifyData.product.available),n},getCartValue:function(){if(console.log("🛒 getCartValue (Shopify)"),t.shopifyData?.cart?.total_price!==r){const e=t.shopifyData.cart.total_price;return console.log("   ✅ Via Shopify data:",e),e}try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status){const e=JSON.parse(t.responseText).total_price/100;return console.log("   ✅ Via API /cart.js:",e),e}}catch(t){console.log("   ❌ Erro API:",t)}const n=["[data-cart-total]",".cart-total","#cart-total",".basket-total",".cart__total",".drawer-cart__total"];for(const t of n){const r=e.querySelector(t);if(r){const t=r.textContent||r.value||r.getAttribute("data-cart-total");if(t){const e=this.parseCartValue(t);if(null!==e)return console.log("   ✅ Via DOM:",e),e}}}return console.log("   ⚠️ Fallback para 0"),0},getCartItemCount:function(){if(t.shopifyData?.cart?.item_count!==r)return t.shopifyData.cart.item_count;try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).item_count}catch(t){console.log("Erro ao buscar item count:",t)}return e.querySelectorAll("[data-cart-item], .cart-item, .line-item").length},getCartToken:function(){try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status)return JSON.parse(t.responseText).token}catch(t){return null}},parseCartValue:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const r=parseFloat(e);return r>1e4?r/100:isNaN(r)?null:r},setupShopifyTracking:function(){const e=t.InfluencerTracker;"product"===t.shopifyData?.page?.type&&e.trackCustomEvent("product_view",{product_id:t.shopifyData.product?.id,product_handle:t.shopifyData.product?.handle,product_title:t.shopifyData.product?.title,product_price:t.shopifyData.product?.price,product_type:t.shopifyData.product?.type,product_vendor:t.shopifyData.product?.vendor,product_available:t.shopifyData.product?.available,variants_count:t.shopifyData.product?.variants?.length}),"collection"===t.shopifyData?.page?.type&&e.trackCustomEvent("collection_view",{collection_id:t.shopifyData.collection?.id,collection_handle:t.shopifyData.collection?.handle,collection_title:t.shopifyData.collection?.title,products_count:t.shopifyData.collection?.products_count}),"cart"===t.shopifyData?.page?.type&&e.trackCustomEvent("cart_view",{cart_items:t.shopifyData.cart?.item_count||0,cart_total:t.shopifyData.cart?.total_price||0,cart_items_detail:t.shopifyData.cart?.items||[]})},setupCartTracking:function(){t.InfluencerTracker,console.log("🛒 Setup cart tracking (sem event listeners de click/submit)");const r=new MutationObserver(t=>{let e=!1;t.forEach(t=>{"childList"===t.type&&[...t.addedNodes,...t.removedNodes].some(t=>t.nodeType===Node.ELEMENT_NODE&&(t.matches?.("[data-cart-item], .cart-item, .line-item")||t.querySelector?.("[data-cart-item], .cart-item, .line-item")||t.classList?.contains("cart-item")))&&(e=!0),"attributes"===t.type&&["data-cart-item","data-quantity","data-cart-total"].includes(t.attributeName)&&(e=!0)}),e&&this.checkCartChange("dom_mutation")});let n=0;["[data-cart-container]",".cart-drawer",".mini-cart",".cart-items",".cart",".cart-form"].forEach(t=>{const i=e.querySelector(t);i&&(r.observe(i,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-cart-item","data-quantity","data-cart-total"]}),n++,console.log(`👀 Observando container: ${t}`))}),0===n&&(r.observe(e.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-cart-item","data-quantity","data-cart-total"]}),console.log("👀 Observando body como fallback")),setInterval(()=>{this.checkCartChange("periodic_check")},45e3),this.lastCartState={items:this.getCartItemCount(),value:this.getCartValue()},console.log("🛒 Estado inicial do carrinho:",this.lastCartState),console.log(`✅ Cart tracking ativo (${n} containers observados)`)},setupProductTracking:function(){const r=t.InfluencerTracker,n=new IntersectionObserver(t=>{t.forEach(t=>{if(t.isIntersecting){const e=t.target;r.trackCustomEvent("product_impression",{product_id:e.getAttribute("data-product-id"),product_handle:e.getAttribute("data-product-handle"),product_title:e.getAttribute("data-product-title"),product_price:e.getAttribute("data-product-price"),visibility_percent:Math.round(100*t.intersectionRatio),element_position:this.getElementPosition(e)})}})},{threshold:.5});["[data-product-id]",".product-item",".product-card",".grid-product",".product-grid-item"].forEach(t=>{e.querySelectorAll(t).forEach(t=>{n.observe(t)})}),e.addEventListener("change",e=>{if(e.target.matches('select[name="id"], input[name="id"], .product-form__variants select')){const n=e.target.value;r.trackCustomEvent("variant_selection",{product_id:t.shopifyData?.product?.id,variant_id:n,selection_method:e.target.tagName.toLowerCase()})}})},setupCheckoutTracking:function(){const e=t.InfluencerTracker;t.location.pathname.includes("/checkout")&&(e.trackCustomEvent("checkout_page_view",{checkout_step:this.getCheckoutStep(),cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.setupCheckoutStepTracking()),(t.location.pathname.includes("/thank_you")||t.location.pathname.includes("/orders/"))&&this.trackPurchaseCompletion()},setupCheckoutStepTracking:function(){const r=t.InfluencerTracker,n=new MutationObserver(()=>{const t=this.getCheckoutStep();this.lastCheckoutStep!==t&&(r.trackCustomEvent("shopify_checkout_step_change",{previous_step:this.lastCheckoutStep,current_step:t,cart_items:this.getCartItemCount(),cart_value:this.getCartValue()}),this.lastCheckoutStep=t)}),i=e.querySelector(".checkout, #checkout, .main-content")||e.body;n.observe(i,{childList:!0,subtree:!0})},checkCartChange:function(e){this.cartUpdateTimeout&&clearTimeout(this.cartUpdateTimeout),this.cartUpdateTimeout=setTimeout(()=>{const r={items:this.getCartItemCount(),value:this.getCartValue()};(!this.lastCartState||r.items!==this.lastCartState.items||Math.abs(r.value-this.lastCartState.value)>.01)&&(console.log("🛒 Cart mudou:",this.lastCartState,"→",r),t.InfluencerTracker.track("cart_update",{cart_items:r.items,cart_value:r.value,previous_items:this.lastCartState?.items||0,previous_value:this.lastCartState?.value||0,change_trigger:e,change_type:r.items>(this.lastCartState?.items||0)?"add":r.items<(this.lastCartState?.items||0)?"remove":"update"}),this.lastCartState=r)},1e3)},getCheckoutStep:function(){return e.querySelector('.step-contact, [data-step="contact"]')?"contact":e.querySelector('.step-shipping, [data-step="shipping"]')?"shipping":e.querySelector('.step-payment, [data-step="payment"]')?"payment":e.querySelector('.step-review, [data-step="review"]')?"review":"unknown"},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:e.left,y:e.top,width:e.width,height:e.height}},trackPurchaseCompletion:function(){const e=t.InfluencerTracker,r=this.extractOrderData();e.trackCustomEvent("purchase_completed",{...r,influencer_attribution:JSON.parse(sessionStorage.getItem("inf_attribution")||"null"),page_url:t.location.href}),r.order_id&&e.trackPurchase({orderId:r.order_id,totalValue:r.total_value,currency:r.currency,items:r.items,couponCode:r.coupon_code})},extractOrderData:function(){if(t.Shopify?.checkout)return{order_id:t.Shopify.checkout.order_id,total_value:t.Shopify.checkout.total_price/100,currency:t.Shopify.checkout.currency,items:t.Shopify.checkout.line_items,coupon_code:t.Shopify.checkout.discount?.code};const r=e.querySelector(".order-number, [data-order-number]")?.textContent,n=e.querySelector(".total-price, [data-total-price]");return{order_id:r,total_value:n?this.parseCartValue(n.textContent):0,currency:"USD",items:[],coupon_code:null}}}}(t,e),function(t,e){const r={sessionStart:Date.now(),behaviorMetrics:{pageViews:0,productViews:0,cartActions:0,totalClicks:0,scrollDepth:[],timeOnPages:[]},analyzeBehavior:function(){const t=Date.now()-this.sessionStart,e=this.behaviorMetrics;return{behavioral_segment:this.getBehavioralSegment(e,t),conversion_probability:this.getConversionProbability(e,t),engagement_quality:this.getEngagementQuality(e,t),device_tier:this.getDeviceTier(),attribution_confidence:this.getAttributionConfidence()}},getBehavioralSegment:function(t,e){return t.cartActions>0&&e<3e5?"decisive_buyer":t.cartActions>2?"hesitant_buyer":t.productViews>5&&0===t.cartActions?"researcher":t.totalClicks>10?"price_conscious":"casual_browser"},getConversionProbability:function(t,e){let r=0;return t.cartActions>0&&(r+=40),t.productViews>3&&(r+=20),e>18e4&&(r+=20),t.totalClicks>5&&(r+=10),t.pageViews>5&&(r+=10),r>=70?"high":r>=40?"medium":"low"},getEngagementQuality:function(t,e){const r=t.scrollDepth.length>0?t.scrollDepth.reduce((t,e)=>t+e,0)/t.scrollDepth.length:0;let n=0;return n+=5*t.pageViews,n+=e/1e3*.1,n+=2*t.totalClicks,n+=.5*r,n>=100?"high":n>=50?"medium":"low"},getDeviceTier:function(){const e=navigator.deviceMemory||4,r=navigator.hardwareConcurrency||4,n=t.screen,i=n.width*n.height;return e>=8&&r>=8&&i>2073600?"premium":e>=4&&i>921600?"mid_range":"budget"},getAttributionConfidence:function(){let r=.3;const n=new URLSearchParams(t.location.search);return(n.get("affiliate")||n.get("ref"))&&(r+=.4),n.get("utm_source")&&(r+=.2),e.referrer&&["instagram.com","tiktok.com","youtube.com","facebook.com"].some(t=>e.referrer.includes(t))&&(r+=.1),Math.min(r,1)},updateMetrics:function(t,e){switch(t){case"page_view":this.behaviorMetrics.pageViews++;break;case"product_view":this.behaviorMetrics.productViews++;break;case"add_to_cart":case"remove_from_cart":this.behaviorMetrics.cartActions++;break;case"click":this.behaviorMetrics.totalClicks++;break;case"scroll":e&&e.scroll_percent&&this.behaviorMetrics.scrollDepth.push(e.scroll_percent)}},sendAnalysis:function(){const e=this.analyzeBehavior();t.InfluencerTracker&&t.InfluencerTracker.track("ai_session_analysis",{session_analysis:e,session_duration:Date.now()-this.sessionStart,total_events:Object.values(this.behaviorMetrics).reduce((t,e)=>Array.isArray(e)?t+e.length:t+e,0)})}};if(t.InfluencerTracker){const e=t.InfluencerTracker.track;t.InfluencerTracker.track=function(t,n={}){r.updateMetrics(t,n),e.call(this,t,n)},t.InfluencerTracker.getAIAnalysis=function(){return r.analyzeBehavior()}}setInterval(()=>{r.sendAnalysis()},3e5),t.addEventListener("beforeunload",()=>{r.sendAnalysis()}),t.AISessionAnalyzer=r,console.log("🤖 AI Session Analyzer integrated with existing customer_sessions")}(t,e),function(t){t.InfluencerTrackerUtils={debounce:function(t,e,r){let n;return function(){const i=this,a=arguments,o=r&&!n;clearTimeout(n),n=setTimeout(function(){n=null,r||t.apply(i,a)},e),o&&t.apply(i,a)}},throttle:function(t,e){let r;return function(){const n=arguments;r||(t.apply(this,n),r=!0,setTimeout(()=>r=!1,e))}},getElementPosition:function(t){const e=t.getBoundingClientRect();return{x:Math.round(e.left),y:Math.round(e.top),width:Math.round(e.width),height:Math.round(e.height)}},parseCurrency:function(t){if(!t)return null;let e=(t=String(t).trim()).replace(/[^\d.,\-]/g,"");if(e.includes(",")&&e.includes("."))e=e.lastIndexOf(",")>e.lastIndexOf(".")?e.replace(/\./g,"").replace(",","."):e.replace(/,/g,"");else if(e.includes(",")){const t=e.split(",");e=2===t.length&&t[1].length<=2?e.replace(",","."):e.replace(/,/g,"")}const r=parseFloat(e);return r>1e4?r/100:isNaN(r)?null:r},isElementVisible:function(r){const n=r.getBoundingClientRect();return n.top>=0&&n.left>=0&&n.bottom<=(t.innerHeight||e.documentElement.clientHeight)&&n.right<=(t.innerWidth||e.documentElement.clientWidth)},getScrollPercentage:function(){const r=t.pageYOffset||e.documentElement.scrollTop,n=e.documentElement.scrollHeight-t.innerHeight;return Math.round(r/n*100)},setCookie:function(t,r,n){const i=n?`; expires=${new Date(Date.now()+864e5*n).toUTCString()}`:"";e.cookie=`${t}=${r}${i}; path=/`},getCookie:function(t){return e.cookie.split("; ").reduce((e,r)=>{const n=r.split("=");return n[0]===t?decodeURIComponent(n[1]):e},"")},setStorage:function(t,e,r=!1){try{return(r?sessionStorage:localStorage).setItem(t,JSON.stringify(e)),!0}catch(n){return console.warn("Storage not available, using cookie fallback"),this.setCookie(t,JSON.stringify(e),r?null:30),!1}},getStorage:function(t,e=!1){try{const r=(e?sessionStorage:localStorage).getItem(t);return r?JSON.parse(r):null}catch(e){const r=this.getCookie(t);return r?JSON.parse(r):null}}}}(t)}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:{});