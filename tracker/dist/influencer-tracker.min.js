/* Influencer Tracker v2.1.0 for Shopify | Built: 2025-09-03T18:34:37.418Z */
!function(t,e){"use strict";t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.BuildInfo={name:"shopify-full",version:"2.1.0",platform:"shopify",timestamp:"2025-09-03T18:34:37.425Z",modules:["modules/config.js","utils/utils.js","modules/consent-manager.js","modules/id-generator.js","modules/influencer-detector.js","modules/device-fingerprint.js","modules/event-queue.js","core/tracker-core.js","adapters/shopify-adapter.js","ai/ai-data-collector.js"],features:{tracking:!0,attribution:!0,shopify:!0,ai:!0}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.Config={defaults:{apiEndpoint:"",projectId:"",enableConsentCheck:!0,batchSize:10,batchTimeout:3e3,sessionTimeout:18e5,version:"2.0.0"},current:{},init:function(){this.current=Object.assign({},this.defaults)},update:function(t={}){Object.assign(this.current,t)},get:function(t){return this.current[t]},getAll:function(){return Object.assign({},this.current)},isValid:function(){return!(!this.current.apiEndpoint||!this.current.projectId)}},t.InfluencerTracker.Config.init(),t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.Utils={throttle:function(t,e){let n;return function(){const i=arguments;n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}},debounce:function(t,e,n){let i;return function(){const o=this,r=arguments,a=n&&!i;clearTimeout(i),i=setTimeout(function(){i=null,n||t.apply(o,r)},e),a&&t.apply(o,r)}},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},isTablet:function(){return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent)},getDeviceType:function(){return this.isMobile()?"mobile":this.isTablet()?"tablet":"desktop"},isElementVisible:function(n){const i=n.getBoundingClientRect();return i.top>=0&&i.left>=0&&i.bottom<=(t.innerHeight||e.documentElement.clientHeight)&&i.right<=(t.innerWidth||e.documentElement.clientWidth)},getScrollPercentage:function(){const n=t.pageYOffset||e.documentElement.scrollTop,i=e.documentElement.scrollHeight-t.innerHeight;return Math.round(n/i*100)},getUrlParams:function(){const e={},n=new URLSearchParams(t.location.search);for(const[t,i]of n)e[t]=i;return e},sanitizeString:function(t){return"string"!=typeof t?t:t.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").trim()},isValidEmail:function(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)},formatTimestamp:function(t){return new Date(t).toISOString()},deepMerge:function(t,e){const n=Object.assign({},t);for(const t in e)e.hasOwnProperty(t)&&("object"!=typeof e[t]||null===e[t]||Array.isArray(e[t])?n[t]=e[t]:n[t]=this.deepMerge(n[t]||{},e[t]));return n}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.ConsentManager={CONSENT_KEY:"analytics_consent",CONSENT_DATE_KEY:"analytics_consent_date",pendingCallbacks:[],checkConsent:function(){if(!t.InfluencerTracker.Config.get("enableConsentCheck"))return!0;const e=localStorage.getItem(this.CONSENT_KEY),n=localStorage.getItem(this.CONSENT_DATE_KEY);if("granted"===e&&n){const t=Date.now()-31536e6;return parseInt(n)>t}return!1},waitForConsent:function(t,e=1e4){if(this.checkConsent())return void t();this.pendingCallbacks.push(t);const n=Date.now(),i=setInterval(()=>{this.checkConsent()?(clearInterval(i),this.triggerPendingCallbacks()):Date.now()-n>e&&(clearInterval(i),console.warn("Influencer Tracker: Consent timeout reached"))},500)},setConsent:function(t=!0){localStorage.setItem(this.CONSENT_KEY,t?"granted":"denied"),localStorage.setItem(this.CONSENT_DATE_KEY,Date.now().toString()),t&&this.triggerPendingCallbacks()},triggerPendingCallbacks:function(){this.pendingCallbacks.forEach(t=>{try{t()}catch(t){console.error("Consent callback error:",t)}}),this.pendingCallbacks=[]},revokeConsent:function(){localStorage.removeItem(this.CONSENT_KEY),localStorage.removeItem(this.CONSENT_DATE_KEY)}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.IdGenerator={USER_ID_KEY:"inf_user_id",SESSION_KEY:"inf_session",generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},getUserId:function(){let t=localStorage.getItem(this.USER_ID_KEY);return t||(t=this.generateUUID(),localStorage.setItem(this.USER_ID_KEY,t)),t},getSessionId:function(){let e=sessionStorage.getItem(this.SESSION_KEY);const n=t.InfluencerTracker.Config.get("sessionTimeout");if(e)try{const t=JSON.parse(e),i=Date.now();if(i-t.lastActivity<n)return t.lastActivity=i,sessionStorage.setItem(this.SESSION_KEY,JSON.stringify(t)),t.id}catch(t){console.warn("Invalid session data, creating new session")}const i={id:this.generateUUID(),startTime:Date.now(),lastActivity:Date.now()};return sessionStorage.setItem(this.SESSION_KEY,JSON.stringify(i)),i.id},getSessionInfo:function(){const t=sessionStorage.getItem(this.SESSION_KEY);if(t)try{return JSON.parse(t)}catch(t){return null}return null},invalidateSession:function(){sessionStorage.removeItem(this.SESSION_KEY)}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.InfluencerDetector={ATTRIBUTION_KEY:"inf_attribution",socialNetworks:{"instagram.com":"instagram","tiktok.com":"tiktok","youtube.com":"youtube","youtu.be":"youtube","facebook.com":"facebook","twitter.com":"twitter","x.com":"twitter","linkedin.com":"linkedin","pinterest.com":"pinterest","snapchat.com":"snapchat"},detectInfluencer:function(){const n=new URLSearchParams(t.location.search),i=new URLSearchParams(t.location.hash.substring(1)),o={influencer_id:this.getParam(n,i,["inf_id","influencer","inf"]),campaign_id:this.getParam(n,i,["camp_id","campaign","cmp"]),promo_code:this.getParam(n,i,["promo","codigo","discount"]),utm_source:n.get("utm_source"),utm_medium:n.get("utm_medium"),utm_campaign:n.get("utm_campaign"),utm_content:n.get("utm_content"),utm_term:n.get("utm_term"),ref:n.get("ref"),affiliate_id:this.getParam(n,i,["aff_id","affiliate"])},r=this.detectSocialSource();if(Object.values(o).some(t=>null!==t&&""!==t)||r){const n={...o,social_source:r,detected_at:Date.now(),landing_page:t.location.href,referrer:e.referrer,user_agent:navigator.userAgent};return sessionStorage.setItem(this.ATTRIBUTION_KEY,JSON.stringify(n)),n}return this.getSavedAttribution()},getParam:function(t,e,n){for(const i of n){const n=t.get(i)||e.get(i);if(n)return n}return null},detectSocialSource:function(){const t=e.referrer;if(!t)return null;try{const e=new URL(t).hostname.toLowerCase();for(const[t,n]of Object.entries(this.socialNetworks))if(e.includes(t))return n}catch(t){console.warn("Error parsing referrer:",t)}return null},getSavedAttribution:function(){try{const t=sessionStorage.getItem(this.ATTRIBUTION_KEY);return t?JSON.parse(t):null}catch(t){return console.warn("Error parsing saved attribution:",t),null}},clearAttribution:function(){sessionStorage.removeItem(this.ATTRIBUTION_KEY)},hasActiveAttribution:function(){return!!this.getSavedAttribution()}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.DeviceFingerprint={cachedFingerprint:null,generate:function(){if(this.cachedFingerprint)return this.cachedFingerprint;const e=t.screen,n=navigator,i={user_agent:n.userAgent,language:n.language,languages:n.languages?n.languages.join(","):null,platform:n.platform,screen_resolution:`${e.width}x${e.height}`,screen_available:`${e.availWidth}x${e.availHeight}`,color_depth:e.colorDepth,pixel_depth:e.pixelDepth,timezone:this.getTimezone(),timezone_offset:(new Date).getTimezoneOffset(),device_memory:n.deviceMemory||null,hardware_concurrency:n.hardwareConcurrency||null,max_touch_points:n.maxTouchPoints||null,connection:this.getConnectionInfo(),cookies_enabled:n.cookieEnabled,local_storage:this.hasLocalStorage(),session_storage:this.hasSessionStorage(),viewport:this.getViewportInfo(),plugins_count:n.plugins?n.plugins.length:0,generated_at:Date.now()};return this.cachedFingerprint=i,i},getTimezone:function(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){return null}},getConnectionInfo:function(){const t=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return t?{effective_type:t.effectiveType||null,downlink:t.downlink||null,rtt:t.rtt||null,save_data:t.saveData||!1}:null},hasLocalStorage:function(){try{const t="__test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}},hasSessionStorage:function(){try{const t="__test__";return sessionStorage.setItem(t,t),sessionStorage.removeItem(t),!0}catch(t){return!1}},getViewportInfo:function(){return{width:t.innerWidth||e.documentElement.clientWidth,height:t.innerHeight||e.documentElement.clientHeight,device_pixel_ratio:t.devicePixelRatio||1}},generateHash:function(){const t=this.generate(),e=JSON.stringify(t);let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n&=n;return Math.abs(n).toString(36)},clearCache:function(){this.cachedFingerprint=null}},t.InfluencerTracker=t.InfluencerTracker||{},t.InfluencerTracker.EventQueue={queue:[],flushTimer:null,isOnline:navigator.onLine,FAILED_EVENTS_KEY:"inf_failed_events",init:function(){this.setupNetworkListeners(),this.retryFailedEvents()},setupNetworkListeners:function(){const e=this;t.addEventListener("online",function(){e.isOnline=!0,e.retryFailedEvents(),e.queue.length>0&&e.flush()}),t.addEventListener("offline",function(){e.isOnline=!1})},add:function(e){this.queue.push(e);const n=t.InfluencerTracker.Config.get("batchSize");this.queue.length>=n?this.flush():this.scheduleFlush()},scheduleFlush:function(){this.flushTimer&&clearTimeout(this.flushTimer);const e=t.InfluencerTracker.Config.get("batchTimeout");this.flushTimer=setTimeout(()=>{this.flush()},e)},flush:function(){if(0===this.queue.length)return Promise.resolve();const e=t.InfluencerTracker.Config,n=e.get("apiEndpoint"),i=e.get("projectId");if(!n)return console.warn("Influencer Tracker: API endpoint not configured"),Promise.reject(new Error("API endpoint not configured"));const o=this.queue.splice(0,e.get("batchSize")),r={project_id:i,events:o,version:e.get("version"),timestamp:Date.now()};return this.sendEvents(r,o)},sendEvents:function(e,n){const i=t.InfluencerTracker.Config;return fetch(i.get("apiEndpoint"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).catch(t=>{throw console.warn("Influencer Tracker: Failed to send events",t),this.saveFailedEvents(n),t})},saveFailedEvents:function(t){try{const e=JSON.parse(localStorage.getItem(this.FAILED_EVENTS_KEY)||"[]");e.push(...t);const n=e.slice(-100);localStorage.setItem(this.FAILED_EVENTS_KEY,JSON.stringify(n))}catch(t){console.warn("Failed to save failed events:",t)}},retryFailedEvents:function(){if(this.isOnline)try{const t=JSON.parse(localStorage.getItem(this.FAILED_EVENTS_KEY)||"[]");t.length>0&&(console.log(`Retrying ${t.length} failed events`),this.queue.unshift(...t),localStorage.removeItem(this.FAILED_EVENTS_KEY),this.flush())}catch(t){console.warn("Error retrying failed events:",t)}},getQueueSize:function(){return this.queue.length},clear:function(){this.queue=[],this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null)},forceFlush:function(){return this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=null),this.flush()}};const n=t.InfluencerTracker.Config,i=t.InfluencerTracker.ConsentManager,o=t.InfluencerTracker.IdGenerator,r=t.InfluencerTracker.InfluencerDetector,a=t.InfluencerTracker.DeviceFingerprint,c=t.InfluencerTracker.EventQueue,s=t.InfluencerTracker.Utils;t.InfluencerTracker.Core={initialized:!1,startTime:Date.now(),platform:"generic",adapter:null,init:function(t={}){this.initialized?console.warn("Influencer Tracker already initialized"):(n.update(t),n.isValid()?(c.init(),this.platform=this.detectPlatform(),console.log(`🎯 Plataforma detectada: ${this.platform}`),this.adapter=this.loadAdapter(this.platform),!n.get("enableConsentCheck")||i.checkConsent()?this.startTracking():i.waitForConsent(()=>this.startTracking())):console.warn("Influencer Tracker: Invalid configuration - missing apiEndpoint or projectId"))},detectPlatform:function(){return t.Shopify||t.shopifyData||e.querySelector('meta[name="shopify-checkout-api-token"]')?"shopify":t.vtex||t.vtexjs||e.querySelector('meta[name="vtex-version"]')?"vtex":t.LS||e.querySelector('meta[name="nuvemshop"]')?"nuvemshop":t.wc||e.querySelector('meta[name="generator"][content*="WooCommerce"]')?"woocommerce":"generic"},loadAdapter:function(e){return t[`${e}Adapter`]||null},startTracking:function(){this.initialized=!0;const n=r.detectInfluencer();this.track("page_view",{page_url:t.location.href,page_title:e.title,referrer:e.referrer,influencer_data:n,device_type:s.getDeviceType(),viewport:a.generate().viewport}),this.setupUniversalTracking(),this.adapter&&this.adapter.init&&this.adapter.init(),t.addEventListener("beforeunload",()=>{c.forceFlush()}),e.addEventListener("visibilitychange",()=>{"hidden"===e.visibilityState&&c.forceFlush()}),console.log("🎯 Influencer Tracker: Inicializado com sucesso")},track:function(e,n={}){if(!this.initialized)return void console.warn("Tracker not initialized");const i={event_id:o.generateUUID(),event_type:e,timestamp:Date.now(),user_id:o.getUserId(),session_id:o.getSessionId(),page_url:t.location.href,device_fingerprint:a.generate(),platform:this.platform,properties:s.deepMerge({},n)};if(this.adapter&&this.adapter.enrichEvent){const t=this.adapter.enrichEvent(e,n);i.properties=s.deepMerge(i.properties,t)}c.add(i)},setupUniversalTracking:function(){let e=0;t.addEventListener("scroll",s.throttle(()=>{const t=s.getScrollPercentage();t>e&&(e=t,[25,50,75,90].includes(t)&&this.track("scroll_milestone",{scroll_percent:t,max_scroll:e}))},1e3));let n=0;const i=setInterval(()=>{n+=10,[30,60,120,300].includes(n)&&this.track("time_milestone",{seconds_on_page:n,session_duration:Date.now()-this.startTime})},1e4);t.addEventListener("beforeunload",()=>{clearInterval(i)}),this.setupExitTracking()},setupExitTracking:function(){let n=!1;e.addEventListener("mouseleave",e=>{e.clientY<=0&&!n&&(n=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:s.getScrollPercentage(),page_url:t.location.href}))})},trackPurchase:function(t){this.track("purchase",{order_id:t.orderId,total_value:t.totalValue,currency:t.currency||"BRL",items:t.items,coupon_code:t.couponCode,payment_method:t.paymentMethod,influencer_attribution:r.getSavedAttribution()})},trackCustomEvent:function(t,e){this.track(s.sanitizeString(t),e)},getInfo:function(){return{initialized:this.initialized,platform:this.platform,version:n.get("version"),userId:o.getUserId(),sessionId:o.getSessionId(),queueSize:c.getQueueSize(),hasAttribution:r.hasActiveAttribution()}}},function(t,e){const n={initialized:!1,startTime:Date.now(),lastCartState:null,lastScrollPercent:0,timeOnPage:0,exitTracked:!1,checkoutStartTime:null,checkoutSteps:[],currentStep:null,checkoutSessionData:{},formInteractions:{},abandonmentTracked:!1,init:function(){this.initialized||(console.log("🔄 Inicializando Hybrid Shopify Tracker"),this.setupUniversalEcommerce(),this.setupBehavioralTracking(),this.setupShopifySpecific(),this.setupAdvancedCheckoutTracking(),this.initializeState(),this.initialized=!0,console.log("✅ Hybrid Shopify Tracker inicializado com checkout tracking"))},setupUniversalEcommerce:function(){console.log("🛒 Configurando tracking de ecommerce universal"),this.interceptShopifyAPIs(),this.listenToShopifyEvents(),this.setupSmartPolling()},interceptShopifyAPIs:function(){const e=this,n=t.fetch;t.fetch=async function(...t){const i=await n.apply(this,t);if(i.ok){const n="string"==typeof t[0]?t[0]:t[0].url;try{if(n.includes("/cart")){const t=i.clone();if(n.includes("/cart/add")){const i=await t.json();e.handleCartAdd(i,n)}else if(n.includes("/cart/update")||n.includes("/cart/change")){const i=await t.json();e.handleCartUpdate(i,n)}else if(n.includes("/cart/clear"))e.handleCartClear(n);else if(n.includes("/cart.js")||n.endsWith("/cart")){const i=await t.json();e.handleCartData(i,n)}}if(n.includes("/products/")&&n.includes(".js")){const t=await clonedResponse.json();e.handleProductData(t,n)}if(n.includes("/checkout")||n.includes("/orders")){const t=i.headers.get("content-type");if(t&&t.includes("application/json")){const t=await clonedResponse.json();e.handleCheckoutData(t,n)}}}catch(t){console.log("🔄 Erro ao processar resposta:",t)}}return i};const i=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(t,n,...o){return n.includes("/cart")&&this.addEventListener("load",function(){if(this.status>=200&&this.status<300)try{const t=JSON.parse(this.responseText);n.includes("/cart/add")?e.handleCartAdd(t,n):n.includes("/cart/update")||n.includes("/cart/change")?e.handleCartUpdate(t,n):n.includes("/cart.js")&&e.handleCartData(t,n)}catch(t){}}),i.apply(this,[t,n,...o])},console.log("✅ Interceptação de APIs configurada")},listenToShopifyEvents:function(){["cart:updated","cart:added","cart:removed","cart:changed","product:added-to-cart","ajaxCart:updated","drawer:updated"].forEach(t=>{e.addEventListener(t,e=>{console.log(`🛒 Evento Shopify detectado: ${t}`),setTimeout(()=>{this.refreshCartState("shopify_event",t,e.detail)},300)})}),t.jQuery&&(0,t.jQuery)(e).on("cart.requestComplete",(t,e)=>{console.log("🛒 Evento jQuery cart.requestComplete"),this.handleCartData(e,"jquery_event")})},setupSmartPolling:function(){let t=3e4;const n=async()=>{try{const t=await fetch("/cart.js");if(t.ok){const e=await t.json();this.handleCartData(e,"polling")}}catch(t){console.log("🔄 Erro no polling:",t)}};setInterval(()=>{const i=e.hasFocus()&&!e.hidden;t=i?2e4:6e4,n()},t),console.log("✅ Polling inteligente configurado")},handleCartAdd:function(t,e){console.log("🛒 Produto adicionado ao carrinho:",t),this.track("cart_add",{product_id:t.product_id,variant_id:t.variant_id||t.id,quantity:t.quantity||1,price:t.price?t.price/100:null,title:t.title||t.product_title,vendor:t.vendor,product_type:t.product_type,api_endpoint:e,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_add"),500)},handleCartUpdate:function(t,e){console.log("🛒 Carrinho atualizado:",t),this.track("cart_update_action",{updates:t.updates||t,api_endpoint:e,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_update"),500)},handleCartClear:function(t){console.log("🛒 Carrinho limpo"),this.track("cart_clear",{api_endpoint:t,timestamp:Date.now()}),setTimeout(()=>this.refreshCartState("cart_clear"),500)},handleCartData:function(t,e){const n={items:t.item_count||0,total:t.total_price?t.total_price/100:0,currency:t.currency||"USD",token:t.token};if(!this.lastCartState||n.items!==this.lastCartState.items||Math.abs(n.total-this.lastCartState.total)>.01){console.log("🛒 Estado do carrinho mudou:",this.lastCartState,"→",n);const i=this.determineChangeType(this.lastCartState,n);this.track("cart_update",{cart_items:n.items,cart_value:n.total,cart_currency:n.currency,cart_token:n.token,previous_items:this.lastCartState?.items||0,previous_value:this.lastCartState?.total||0,change_type:i,change_trigger:e,items_detail:t.items?t.items.map(t=>({product_id:t.product_id,variant_id:t.variant_id,quantity:t.quantity,price:t.price/100,line_price:t.line_price/100,title:t.title,vendor:t.vendor,product_type:t.product_type,handle:t.handle,sku:t.sku,grams:t.grams,properties:t.properties})):[],total_discount:t.total_discount?t.total_discount/100:0,discounts:t.cart_level_discount_applications||[],cart_note:t.note,cart_attributes:t.attributes||{},timestamp:Date.now()}),this.lastCartState=n}},handleProductData:function(t,e){console.log("📦 Dados de produto carregados:",t),this.track("product_data_loaded",{product_id:t.id,product_handle:t.handle,product_title:t.title,product_type:t.product_type,vendor:t.vendor,price_min:t.price_min/100,price_max:t.price_max/100,available:t.available,variants_count:t.variants?t.variants.length:0,images_count:t.images?t.images.length:0,tags:t.tags||[],api_endpoint:e,timestamp:Date.now()})},handleCheckoutData:function(t,e){console.log("💳 Dados de checkout:",t),this.track("checkout_data",{checkout_data:t,api_endpoint:e,timestamp:Date.now()})},setupBehavioralTracking:function(){console.log("👤 Configurando tracking comportamental"),this.trackScrollBehavior(),this.trackTimeOnPage(),this.trackExitIntent(),this.trackClickBehavior(),this.trackFormInteractions(),this.trackPageVisibility()},trackScrollBehavior:function(){t.addEventListener("scroll",this.throttle(()=>{const n=Math.round(t.scrollY/(e.body.scrollHeight-t.innerHeight)*100);if(n>this.lastScrollPercent&&(this.lastScrollPercent=n,[25,50,75,90].includes(n))){const i={scroll_percent:n,scroll_depth:t.scrollY,page_height:e.body.scrollHeight,viewport_height:t.innerHeight,timestamp:Date.now()};this.track("scroll_milestone",i),this.saveScrollMilestone(i)}},1e3))},trackTimeOnPage:function(){setInterval(()=>{this.timeOnPage+=10,[30,60,120,300,600].includes(this.timeOnPage)&&this.track("time_milestone",{seconds_on_page:this.timeOnPage,minutes_on_page:Math.round(this.timeOnPage/60),is_active:e.hasFocus(),timestamp:Date.now()})},1e4)},trackExitIntent:function(){e.addEventListener("mouseleave",n=>{n.clientY<=0&&!this.exitTracked&&(this.exitTracked=!0,this.track("exit_intent",{time_on_page:Date.now()-this.startTime,scroll_percent:this.lastScrollPercent,page_url:t.location.href,referrer:e.referrer,timestamp:Date.now()}))})},trackClickBehavior:function(){e.addEventListener("click",this.throttle(t=>{const e=t.target;let n="generic";e.matches('a[href*="/products/"]')?n="product_link":e.matches('button[name="add"], input[name="add"]')?n="add_to_cart_button":e.matches('a[href*="/cart"], button[data-cart]')?n="cart_link":e.matches('a[href*="/checkout"]')&&(n="checkout_link");const i={click_type:n,element_tag:e.tagName,element_class:e.className,element_id:e.id,element_text:e.textContent?.substring(0,100),href:e.href,position_x:t.clientX,position_y:t.clientY,timestamp:Date.now()};this.track("click_event",i),this.saveInteraction({type:"click",...i})},500))},trackFormInteractions:function(){e.addEventListener("submit",t=>{const e=t.target;let n="generic";e.action&&e.action.includes("/cart/add")?n="add_to_cart":e.action&&e.action.includes("/contact")?n="contact":e.querySelector('input[type="email"]')&&(n="newsletter"),this.track("form_submit",{form_type:n,form_action:e.action,form_method:e.method,fields_count:e.elements.length,timestamp:Date.now()})})},trackPageVisibility:function(){e.addEventListener("visibilitychange",()=>{this.track("page_visibility_change",{is_visible:!e.hidden,time_on_page:Date.now()-this.startTime,timestamp:Date.now()})})},setupShopifySpecific:function(){console.log("🛍️ Configurando tracking específico do Shopify"),this.trackPageType(),this.trackCustomerData(),this.trackShopData(),this.trackVariantSelections()},trackPageType:function(){const n=t.location.pathname;let i="other";n.includes("/products/")?(i="product",this.trackProductView()):n.includes("/collections/")?(i="collection",this.trackCollectionView()):n.includes("/cart")?i="cart":n.includes("/checkout")?i="checkout":"/"!==n&&""!==n||(i="home"),this.track("page_view_detailed",{page_type:i,page_path:n,page_title:e.title,referrer:e.referrer,timestamp:Date.now()})},trackProductView:function(){const t=this.extractProductData();t&&(this.track("product_view",{...t,timestamp:Date.now()}),this.saveProductView(t))},trackCollectionView:function(){const t=this.extractCollectionData();t&&this.track("collection_view",{...t,timestamp:Date.now()})},trackVariantSelections:function(){['input[name="id"]','select[name="id"]',"[data-variant-id]",".product-variant-id"].forEach(t=>{e.querySelectorAll(t).forEach(t=>{t.addEventListener("change",()=>{this.track("variant_selection",{product_id:this.getProductId(),variant_id:t.value||t.dataset.variantId,product_handle:this.getProductHandle(),selection_method:t.tagName.toLowerCase(),timestamp:Date.now()})})})})},trackCustomerData:function(){const t=this.extractCustomerData();t&&this.track("customer_data",{...t,timestamp:Date.now()})},trackShopData:function(){const t=this.extractShopData();this.track("shop_data",{...t,timestamp:Date.now()})},refreshCartState:function(t,e=null,n=null){setTimeout(async()=>{try{const e=await fetch("/cart.js");if(e.ok){const n=await e.json();this.handleCartData(n,t)}}catch(t){console.log("🔄 Erro ao atualizar estado do carrinho:",t)}},300)},determineChangeType:function(t,e){return t?e.items>t.items?"add":e.items<t.items?"remove":Math.abs(e.total-t.total)>.01?"update":"unknown":"initial"},extractProductData:function(){const n={};if(t.product?(n.product_id=t.product.id,n.product_handle=t.product.handle,n.product_title=t.product.title,n.product_type=t.product.type,n.vendor=t.product.vendor,n.price=t.product.price/100,n.available=t.product.available,n.variants_count=t.product.variants?.length||0):t.meta?.product&&(n.product_id=t.meta.product.id,n.product_handle=t.meta.product.handle),!n.product_id){const t=e.querySelector('meta[property="product:retailer_item_id"]');t&&(n.product_id=t.content)}return Object.keys(n).length>0?n:null},extractCollectionData:function(){const e={};return t.collection&&(e.collection_id=t.collection.id,e.collection_handle=t.collection.handle,e.collection_title=t.collection.title,e.products_count=t.collection.products_count),Object.keys(e).length>0?e:null},extractCustomerData:function(){const e={};return t.customer?(e.customer_id=t.customer.id,e.customer_email=t.customer.email,e.customer_tags=t.customer.tags,e.orders_count=t.customer.orders_count,e.total_spent=t.customer.total_spent):t.Shopify?.customer&&(e.customer_id=t.Shopify.customer.id,e.customer_email=t.Shopify.customer.email),Object.keys(e).length>0?e:null},extractShopData:function(){return{shop_domain:t.Shopify?.shop||t.shopifyData?.shop?.domain,shop_currency:t.Shopify?.currency?.active||t.shopifyData?.shop?.currency,shop_money_format:t.Shopify?.money_format,shop_locale:t.Shopify?.locale}},getProductId:function(){if(t.product?.id)return t.product.id;if(t.meta?.product?.id)return t.meta.product.id;const n=e.querySelector('meta[property="product:retailer_item_id"]');return n?n.content:null},getProductHandle:function(){if(t.product?.handle)return t.product.handle;const e=t.location.pathname.split("/");return e[e.length-1]||null},initializeState:function(){fetch("/cart.js").then(t=>t.json()).then(t=>{this.lastCartState={items:t.item_count||0,total:t.total_price?t.total_price/100:0,currency:t.currency||"USD",token:t.token},console.log("🛒 Estado inicial do carrinho:",this.lastCartState)}).catch(t=>{console.log("⚠️ Erro ao carregar estado inicial do carrinho:",t),this.lastCartState={items:0,total:0,currency:"USD",token:null}}),this.savePageVisit({page_type:this.detectPageType(),referrer:e.referrer}),this.checkForAbandonedCheckout(),console.log("✅ Estado inicial configurado")},detectPageType:function(){const e=t.location.pathname;return e.includes("/products/")?"product":e.includes("/collections/")?"collection":e.includes("/cart")?"cart":e.includes("/checkout")?"checkout":e.includes("/thank_you")||e.includes("/orders/")?"thank_you":"/"===e||""===e?"home":"other"},getInfluencerAttribution:function(){try{return JSON.parse(sessionStorage.getItem("inf_attribution")||"null")}catch(t){return null}},getCustomerJourney:function(){return{session_start:this.startTime,pages_visited:this.getPagesVisited(),products_viewed:this.getProductsViewed(),time_on_site:Date.now()-this.startTime,scroll_milestones:this.getScrollMilestones(),interactions:this.getInteractionHistory()}},getPagesVisited:function(){try{return JSON.parse(sessionStorage.getItem("pages_visited")||"[]")}catch(t){return[]}},getProductsViewed:function(){try{return JSON.parse(sessionStorage.getItem("products_viewed")||"[]")}catch(t){return[]}},getScrollMilestones:function(){try{return JSON.parse(sessionStorage.getItem("scroll_milestones")||"[]")}catch(t){return[]}},getInteractionHistory:function(){try{return JSON.parse(sessionStorage.getItem("interaction_history")||"[]")}catch(t){return[]}},track:function(e,n={}){t.InfluencerTracker&&t.InfluencerTracker.track?t.InfluencerTracker.track(e,n):console.log("📊 Evento rastreado:",e,n)},enrichEvent:function(t,e){return{...this.extractShopData(),...this.extractCustomerData(),platform_version:"hybrid",tracking_method:"universal_api"}},throttle:function(t,e){let n;return function(){const i=arguments;n||(t.apply(this,i),n=!0,setTimeout(()=>n=!1,e))}},savePageVisit:function(n){try{const i=this.getPagesVisited();i.push({url:t.location.href,title:e.title,timestamp:Date.now(),...n}),sessionStorage.setItem("pages_visited",JSON.stringify(i.slice(-50)))}catch(t){console.log("Erro ao salvar visita de página:",t)}},saveProductView:function(t){try{const e=this.getProductsViewed();e.push({timestamp:Date.now(),...t}),sessionStorage.setItem("products_viewed",JSON.stringify(e.slice(-20)))}catch(t){console.log("Erro ao salvar visualização de produto:",t)}},saveScrollMilestone:function(e){try{const n=this.getScrollMilestones();n.push({timestamp:Date.now(),page:t.location.href,...e}),sessionStorage.setItem("scroll_milestones",JSON.stringify(n.slice(-100)))}catch(t){console.log("Erro ao salvar milestone de scroll:",t)}},saveInteraction:function(e){try{const n=this.getInteractionHistory();n.push({timestamp:Date.now(),page:t.location.href,...e}),sessionStorage.setItem("interaction_history",JSON.stringify(n.slice(-200)))}catch(t){console.log("Erro ao salvar interação:",t)}},setupAdvancedCheckoutTracking:function(){console.log("💳 Configurando checkout tracking avançado"),this.isCheckoutPage()&&this.initCheckoutTracking(),this.monitorCheckoutNavigation(),this.isThankYouPage()&&this.handlePurchaseCompletion()},isCheckoutPage:function(){return t.location.pathname.includes("/checkout")||t.location.pathname.includes("/checkouts/")||e.querySelector(".checkout, #checkout, [data-checkout]")||e.querySelector('body.checkout, body[class*="checkout"]')},isThankYouPage:function(){return t.location.pathname.includes("/thank_you")||t.location.pathname.includes("/orders/")||e.querySelector(".order-confirmation, .thank-you, [data-order-confirmation]")},monitorCheckoutNavigation:function(){e.addEventListener("click",t=>{const e=t.target;this.isCheckoutButton(e)&&this.track("checkout_button_clicked",{button_text:e.textContent?.trim(),button_location:this.getElementLocation(e),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),influencer_attribution:this.getInfluencerAttribution(),timestamp:Date.now()})});let n=t.location.href;new MutationObserver(()=>{const e=t.location.href;e!==n&&(this.isCheckoutPage()&&!n.includes("/checkout")&&setTimeout(()=>this.initCheckoutTracking(),500),n=e)}).observe(e,{subtree:!0,childList:!0})},isCheckoutButton:function(t){const e=t.textContent?.toLowerCase()||"",n=t.className?.toLowerCase()||"",i=t.id?.toLowerCase()||"";return["checkout","finalizar","comprar","buy now","purchase"].some(t=>e.includes(t)||n.includes(t)||i.includes(t))||t.matches('[href*="/checkout"], [data-checkout], .checkout-btn, .btn-checkout')},initCheckoutTracking:function(){this.checkoutStartTime||(console.log("💳 Inicializando tracking de checkout"),this.checkoutStartTime=Date.now(),this.checkoutSteps=[],this.currentStep=this.detectCheckoutStep(),this.checkoutSessionData=this.initCheckoutSession(),this.abandonmentTracked=!1,this.track("checkout_started",{checkout_id:this.generateCheckoutId(),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),cart_details:this.getCartDetails(),influencer_attribution:this.getInfluencerAttribution(),customer_journey:this.getCustomerJourney(),entry_method:this.getCheckoutEntryMethod(),device_info:this.getDeviceInfo(),initial_step:this.currentStep,timestamp:Date.now()}),this.saveCheckoutSession(),this.monitorCheckoutSteps(),this.monitorCheckoutForms(),this.monitorCheckoutAbandonment(),this.monitorCheckoutPerformance(),console.log("✅ Checkout tracking ativo para step:",this.currentStep))},initCheckoutSession:function(){return{checkout_id:this.generateCheckoutId(),start_time:Date.now(),steps_data:{},form_interactions:{},performance_metrics:{},user_behavior:{scroll_events:[],click_events:[],focus_events:[]}}},generateCheckoutId:function(){return"checkout_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)},detectCheckoutStep:function(){if(e.querySelector('[data-step="contact"], [data-checkout-step="contact"]'))return"contact";if(e.querySelector('[data-step="shipping"], [data-checkout-step="shipping"]'))return"shipping";if(e.querySelector('[data-step="payment"], [data-checkout-step="payment"]'))return"payment";if(e.querySelector('[data-step="review"], [data-checkout-step="review"]'))return"review";if(e.querySelector(".step-contact, .checkout-step-contact"))return"contact";if(e.querySelector(".step-shipping, .checkout-step-shipping"))return"shipping";if(e.querySelector(".step-payment, .checkout-step-payment"))return"payment";if(e.querySelector(".step-review, .checkout-step-review"))return"review";if(e.querySelector('input[name="email"], #email'))return"contact";if(e.querySelector('select[name="country"], input[name="address1"]'))return"shipping";if(e.querySelector('input[name="number"], [data-payment]'))return"payment";const n=t.location.href;if(n.includes("contact"))return"contact";if(n.includes("shipping"))return"shipping";if(n.includes("payment"))return"payment";if(n.includes("review"))return"review";const i=e.querySelector(".breadcrumb .active, .checkout-nav .active, .step.active");if(i){const t=i.textContent?.toLowerCase()||"";if(t.includes("contact")||t.includes("information"))return"contact";if(t.includes("shipping")||t.includes("delivery"))return"shipping";if(t.includes("payment")||t.includes("billing"))return"payment";if(t.includes("review")||t.includes("confirm"))return"review"}return"unknown"},monitorCheckoutSteps:function(){new MutationObserver(()=>{const t=this.detectCheckoutStep();if(t!==this.currentStep&&"unknown"!==t){const e=Date.now()-this.checkoutStartTime,n=this.currentStep;console.log(`💳 Step mudou: ${n} → ${t}`),n&&"unknown"!==n&&(this.track("checkout_step_completed",{checkout_id:this.checkoutSessionData.checkout_id,step:n,next_step:t,time_on_step:e,step_data:this.getStepData(n),form_interactions:this.formInteractions[n]||{},step_performance:this.getStepPerformance(n),timestamp:Date.now()}),this.checkoutSteps.push({step:n,time_spent:e,completed:!0,data:this.getStepData(n)})),this.track("checkout_step_started",{checkout_id:this.checkoutSessionData.checkout_id,step:t,previous_step:n,total_time_in_checkout:Date.now()-this.checkoutSessionData.start_time,timestamp:Date.now()}),this.currentStep=t,this.checkoutStartTime=Date.now(),this.formInteractions[t]={},this.saveCheckoutSession()}}).observe(e.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-step","data-checkout-step"]})},monitorCheckoutForms:function(){console.log("📝 Monitorando interações com formulários"),e.querySelectorAll("input, select, textarea").forEach(t=>{this.setupFieldMonitoring(t)}),new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&t.querySelectorAll("input, select, textarea").forEach(t=>this.setupFieldMonitoring(t))})})}).observe(e.body,{childList:!0,subtree:!0})},setupFieldMonitoring:function(t){if(t.dataset.trackerMonitored)return;t.dataset.trackerMonitored="true";const e=t.name||t.id||t.placeholder||"unknown",n=t.type||t.tagName.toLowerCase();let i={field_name:e,field_type:n,focus_count:0,input_count:0,total_focus_time:0,value_changes:0,focus_start:null,initial_value:t.value,error_count:0};t.addEventListener("focus",()=>{i.focus_count++,i.focus_start=Date.now(),this.track("checkout_field_focus",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,focus_count:i.focus_count,timestamp:Date.now()})}),t.addEventListener("blur",()=>{if(i.focus_start){const o=Date.now()-i.focus_start;i.total_focus_time+=o,i.focus_start=null,this.track("checkout_field_blur",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,focus_time:o,total_focus_time:i.total_focus_time,has_value:!!t.value,timestamp:Date.now()})}}),t.addEventListener("input",()=>{i.input_count++,t.value!==i.initial_value&&i.value_changes++,this.throttledTrackInput(t,i)}),t.addEventListener("change",()=>{this.track("checkout_field_change",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,new_value:"select-one"===n?t.value:"[hidden]",timestamp:Date.now()})}),setInterval(()=>{(t.classList.contains("error")||t.classList.contains("invalid")||"true"===t.getAttribute("aria-invalid")||t.closest(".error, .invalid, [data-error]"))&&(i.error_count++,this.track("checkout_field_error",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:e,field_type:n,error_count:i.error_count,timestamp:Date.now()}))},2e3),this.formInteractions[this.currentStep]||(this.formInteractions[this.currentStep]={}),this.formInteractions[this.currentStep][e]=i},throttledTrackInput:(()=>{const t=new Map;return function(e,n){const i=n.field_name;t.has(i)&&clearTimeout(t.get(i)),t.set(i,setTimeout(()=>{this.track("checkout_field_input",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,field_name:i,field_type:n.field_type,input_count:n.input_count,value_changes:n.value_changes,has_value:!!e.value,value_length:e.value?.length||0,timestamp:Date.now()}),t.delete(i)},1e3))}})(),monitorCheckoutAbandonment:function(){let n;console.log("🚪 Monitorando abandono de checkout"),t.addEventListener("beforeunload",t=>{!this.abandonmentTracked&&this.isCheckoutPage()&&this.trackCheckoutAbandonment("page_unload")}),e.addEventListener("mouseleave",t=>{t.clientY<=0&&!this.abandonmentTracked&&this.isCheckoutPage()&&this.track("checkout_exit_intent",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,time_in_checkout:Date.now()-this.checkoutSessionData.start_time,time_on_current_step:Date.now()-this.checkoutStartTime,form_completion:this.calculateFormCompletion(),timestamp:Date.now()})});const i=()=>{clearTimeout(n),n=setTimeout(()=>{this.isCheckoutPage()&&!this.abandonmentTracked&&this.track("checkout_inactivity",{checkout_id:this.checkoutSessionData.checkout_id,step:this.currentStep,inactivity_duration:3e5,timestamp:Date.now()})},3e5)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(t=>{e.addEventListener(t,i,{passive:!0})}),i()},trackCheckoutAbandonment:function(t){this.abandonmentTracked||(this.abandonmentTracked=!0,console.log("🚪 Checkout abandonado:",t),this.track("checkout_abandonment",{checkout_id:this.checkoutSessionData.checkout_id,abandonment_reason:t,abandonment_step:this.currentStep,time_in_checkout:Date.now()-this.checkoutSessionData.start_time,time_on_current_step:Date.now()-this.checkoutStartTime,steps_completed:this.checkoutSteps,form_completion:this.calculateFormCompletion(),cart_value:this.getCartValue(),cart_items:this.getCartItemCount(),influencer_attribution:this.getInfluencerAttribution(),customer_journey:this.getCustomerJourney(),device_info:this.getDeviceInfo(),performance_metrics:this.getCheckoutPerformanceMetrics(),timestamp:Date.now()}),this.saveAbandonmentData())},monitorCheckoutPerformance:function(){"PerformanceObserver"in t&&new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"navigation"===t.entryType&&(this.checkoutSessionData.performance_metrics.page_load={load_time:t.loadEventEnd-t.loadEventStart,dom_content_loaded:t.domContentLoadedEventEnd-t.domContentLoadedEventStart,first_paint:t.responseEnd-t.requestStart})})}).observe({entryTypes:["navigation"]});const e=t.fetch;t.fetch=async function(...t){const n=Date.now(),i=await e.apply(this,t),o=Date.now();return t[0]&&"string"==typeof t[0]&&t[0].includes("checkout")&&this.track("checkout_api_request",{checkout_id:this.checkoutSessionData.checkout_id,url:t[0],method:t[1]?.method||"GET",duration:o-n,status:i.status,step:this.currentStep,timestamp:Date.now()}),i}.bind(this)},handlePurchaseCompletion:function(){console.log("🎉 Purchase completed - coletando dados finais");const t=this.extractOrderData(),e=this.getCheckoutSession();this.track("purchase_completed_detailed",{...t,checkout_session:e,customer_journey:this.getCustomerJourney(),influencer_attribution:this.getInfluencerAttribution(),total_checkout_time:e?Date.now()-e.start_time:null,device_info:this.getDeviceInfo(),timestamp:Date.now()}),this.clearCheckoutSession()},getStepData:function(t){const e={};try{switch(t){case"contact":e.email=this.getFieldValue("email"),e.phone=this.getFieldValue("phone"),e.newsletter_signup=this.getCheckboxValue("newsletter");break;case"shipping":e.shipping_method=this.getSelectedShippingMethod(),e.address_country=this.getFieldValue("country"),e.address_state=this.getFieldValue("province"),e.address_city=this.getFieldValue("city"),e.shipping_price=this.getShippingPrice();break;case"payment":e.payment_method=this.getSelectedPaymentMethod(),e.billing_same_as_shipping=this.getCheckboxValue("billing_same_as_shipping")}}catch(t){console.log("Erro ao extrair dados do step:",t)}return e},getFieldValue:function(t){const n=[`input[name="${t}"]`,`select[name="${t}"]`,`textarea[name="${t}"]`,`#${t}`,`input[name*="${t}"]`,`select[name*="${t}"]`];for(const t of n){const n=e.querySelector(t);if(n)return n.value||null}return null},getCheckboxValue:function(t){const n=e.querySelector(`input[name="${t}"], input[name*="${t}"], #${t}`);return n?n.checked:null},getSelectedShippingMethod:function(){const t=e.querySelector('input[name*="shipping"]:checked, select[name*="shipping"] option:checked');return t?t.value||t.textContent:null},getSelectedPaymentMethod:function(){const t=e.querySelector('input[name*="payment"]:checked, select[name*="payment"] option:checked');return t?t.value||t.textContent:null},getShippingPrice:function(){const t=e.querySelector(".shipping-price, [data-shipping-price], .delivery-price");if(t){const e=t.textContent,n=parseFloat(e.replace(/[^0-9.,]/g,"").replace(",","."));return isNaN(n)?null:n}return null},calculateFormCompletion:function(){const t=e.querySelectorAll('input:not([type="hidden"]), select, textarea'),n=Array.from(t).filter(t=>t.value&&""!==t.value.trim());return t.length>0?Math.round(n.length/t.length*100):0},getStepPerformance:function(t){return{api_requests:this.checkoutSessionData.performance_metrics.api_requests||0,load_time:this.checkoutSessionData.performance_metrics.load_time||null,form_interactions:Object.keys(this.formInteractions[t]||{}).length}},getCheckoutEntryMethod:function(){const t=e.referrer;return t.includes("/cart")?"cart_page":t.includes("/products/")?"product_page":t.includes("/collections/")?"collection_page":t.includes("checkout")?"direct_checkout":t?"unknown":"direct_url"},getCartDetails:function(){try{const t=new XMLHttpRequest;if(t.open("GET","/cart.js",!1),t.send(),200===t.status){const e=JSON.parse(t.responseText);return{items:e.items.map(t=>({product_id:t.product_id,variant_id:t.variant_id,quantity:t.quantity,price:t.price/100,title:t.title})),total_discount:e.total_discount/100,currency:e.currency}}}catch(t){console.log("Erro ao obter detalhes do carrinho:",t)}return null},getDeviceInfo:function(){return{user_agent:navigator.userAgent,screen_resolution:`${screen.width}x${screen.height}`,viewport_size:`${t.innerWidth}x${t.innerHeight}`,device_pixel_ratio:t.devicePixelRatio,connection:navigator.connection?{effective_type:navigator.connection.effectiveType,downlink:navigator.connection.downlink}:null,touch_support:"ontouchstart"in t}},getCheckoutPerformanceMetrics:function(){return this.checkoutSessionData.performance_metrics||{}},extractOrderData:function(){const n={};if(t.Shopify?.checkout&&(n.order_id=t.Shopify.checkout.order_id,n.order_number=t.Shopify.checkout.order_number,n.total_price=t.Shopify.checkout.total_price/100,n.currency=t.Shopify.checkout.currency,n.customer_id=t.Shopify.checkout.customer_id),!n.order_id){const t=e.querySelector(".order-number, [data-order-number], .order-id");t&&(n.order_number=t.textContent?.trim())}return n},getElementLocation:function(e){const n=e.getBoundingClientRect();return{x:n.left,y:n.top,width:n.width,height:n.height,viewport_position:{x_percent:Math.round(n.left/t.innerWidth*100),y_percent:Math.round(n.top/t.innerHeight*100)}}},saveCheckoutSession:function(){try{sessionStorage.setItem("checkout_session",JSON.stringify(this.checkoutSessionData))}catch(t){console.log("Erro ao salvar sessão de checkout:",t)}},getCheckoutSession:function(){try{return JSON.parse(sessionStorage.getItem("checkout_session")||"null")}catch(t){return null}},clearCheckoutSession:function(){try{sessionStorage.removeItem("checkout_session")}catch(t){console.log("Erro ao limpar sessão de checkout:",t)}},saveAbandonmentData:function(){const t={checkout_id:this.checkoutSessionData.checkout_id,abandonment_time:Date.now(),step:this.currentStep,cart_value:this.getCartValue(),form_completion:this.calculateFormCompletion(),influencer_attribution:this.getInfluencerAttribution()};try{localStorage.setItem("checkout_abandonment",JSON.stringify(t))}catch(t){console.log("Erro ao salvar dados de abandono:",t)}},checkForAbandonedCheckout:function(){try{const e=JSON.parse(localStorage.getItem("checkout_abandonment")||"null");if(e){const n=Date.now()-e.abandonment_time;n<864e5?(this.track("checkout_recovery_opportunity",{original_checkout_id:e.checkout_id,time_since_abandonment:n,abandoned_step:e.step,abandoned_cart_value:e.cart_value,recovery_page:t.location.href,timestamp:Date.now()}),this.isCheckoutPage()&&(this.track("checkout_recovery_attempt",{original_checkout_id:e.checkout_id,time_since_abandonment:n,timestamp:Date.now()}),localStorage.removeItem("checkout_abandonment"))):localStorage.removeItem("checkout_abandonment")}}catch(t){console.log("Erro ao verificar checkout abandonado:",t)}}};t.shopifyAdapter=n,console.log("🔄 Hybrid Shopify Tracker carregado")}(t,e),function(t,e){const n={sessionStart:Date.now(),behaviorMetrics:{pageViews:0,productViews:0,cartActions:0,totalClicks:0,scrollDepth:[],timeOnPages:[]},analyzeBehavior:function(){const t=Date.now()-this.sessionStart,e=this.behaviorMetrics;return{behavioral_segment:this.getBehavioralSegment(e,t),conversion_probability:this.getConversionProbability(e,t),engagement_quality:this.getEngagementQuality(e,t),device_tier:this.getDeviceTier(),attribution_confidence:this.getAttributionConfidence()}},getBehavioralSegment:function(t,e){return t.cartActions>0&&e<3e5?"decisive_buyer":t.cartActions>2?"hesitant_buyer":t.productViews>5&&0===t.cartActions?"researcher":t.totalClicks>10?"price_conscious":"casual_browser"},getConversionProbability:function(t,e){let n=0;return t.cartActions>0&&(n+=40),t.productViews>3&&(n+=20),e>18e4&&(n+=20),t.totalClicks>5&&(n+=10),t.pageViews>5&&(n+=10),n>=70?"high":n>=40?"medium":"low"},getEngagementQuality:function(t,e){const n=t.scrollDepth.length>0?t.scrollDepth.reduce((t,e)=>t+e,0)/t.scrollDepth.length:0;let i=0;return i+=5*t.pageViews,i+=e/1e3*.1,i+=2*t.totalClicks,i+=.5*n,i>=100?"high":i>=50?"medium":"low"},getDeviceTier:function(){const e=navigator.deviceMemory||4,n=navigator.hardwareConcurrency||4,i=t.screen,o=i.width*i.height;return e>=8&&n>=8&&o>2073600?"premium":e>=4&&o>921600?"mid_range":"budget"},getAttributionConfidence:function(){let n=.3;const i=new URLSearchParams(t.location.search);return(i.get("affiliate")||i.get("ref"))&&(n+=.4),i.get("utm_source")&&(n+=.2),e.referrer&&["instagram.com","tiktok.com","youtube.com","facebook.com"].some(t=>e.referrer.includes(t))&&(n+=.1),Math.min(n,1)},updateMetrics:function(t,e){switch(t){case"page_view":this.behaviorMetrics.pageViews++;break;case"product_view":case"product_impression":this.behaviorMetrics.productViews++;break;case"cart_update":this.behaviorMetrics.cartActions++;break;case"scroll_milestone":e&&e.scroll_percent&&this.behaviorMetrics.scrollDepth.push(e.scroll_percent);break;case"variant_selection":case"product_impression":this.behaviorMetrics.totalClicks++}},sendAnalysis:function(){const e=this.analyzeBehavior();t.InfluencerTracker&&t.InfluencerTracker.track("ai_session_analysis",{session_analysis:e,session_duration:Date.now()-this.sessionStart,total_events:Object.values(this.behaviorMetrics).reduce((t,e)=>Array.isArray(e)?t+e.length:t+e,0)})}};if(t.InfluencerTracker){const e=t.InfluencerTracker.track;t.InfluencerTracker.track=function(t,i={}){n.updateMetrics(t,i),e.call(this,t,i)},t.InfluencerTracker.getAIAnalysis=function(){return n.analyzeBehavior()}}setInterval(()=>{n.sendAnalysis()},3e5),t.addEventListener("beforeunload",()=>{n.sendAnalysis()}),t.AISessionAnalyzer=n,console.log("🤖 AI Session Analyzer integrated with existing customer_sessions")}(t,e);const u=["Config","Utils","Core"].filter(e=>!t.InfluencerTracker[e]);if(u.length>0)console.error("Missing required modules:",u);else{t.InfluencerTracker.instance=t.InfluencerTracker.Core,t.InfluencerTracker.init=function(e){return t.InfluencerTracker.Core.init(e)},t.InfluencerTracker.track=function(e,n){return t.InfluencerTracker.Core.track(e,n)},t.InfluencerTracker.trackPurchase=function(e){return t.InfluencerTracker.Core.trackPurchase(e)},t.InfluencerTracker.getInfo=function(){return t.InfluencerTracker.Core.getInfo()};const n=e.currentScript;if(n&&"false"!==n.dataset.autoInit){const e={};n.dataset.apiEndpoint&&(e.apiEndpoint=n.dataset.apiEndpoint),n.dataset.projectId&&(e.projectId=n.dataset.projectId),Object.keys(e).length>0&&t.InfluencerTracker.init(e)}console.log("🎯 Influencer Tracker v2.1.0 for Shopify loaded"),console.log("📦 Modules loaded:",10),console.log("🛍️ Shopify integration: Ready"),console.log("🤖 AI analytics: Enabled")}}("undefined"!=typeof window?window:this,"undefined"!=typeof document?document:{});